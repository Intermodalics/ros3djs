var ROS3D=function(e,t,i,s){"use strict";s=s&&s.hasOwnProperty("default")?s.default:s;var o=Object.assign({},t),r=0,a=1,n=2,c=3,h=4,l=5,d=6,p=7,u=8,m=9,f=10,v=11,g=1,b=2,y=3,w=4,x=5,T=0,E=2,M=3,k=4,C=5,A=7,N=9,O=0,_=1,R=2,D=function(e,t,i,s){var r=new o.Color;return r.setRGB(e,t,i),s<=.99?new o.MeshBasicMaterial({color:r.getHex(),opacity:s+.1,transparent:!0,depthWrite:!0,blendSrc:o.SrcAlphaFactor,blendDst:o.OneMinusSrcAlphaFactor,blendEquation:o.ReverseSubtractEquation,blending:o.NormalBlending}):new o.MeshPhongMaterial({color:r.getHex(),opacity:s,blending:o.NormalBlending})},S=function(e,t,i){var s=new o.Vector3,r=new o.Vector3;s.subVectors(t,e.origin);var a=e.direction.dot(i);if(!(Math.abs(a)<e.precision)){var n=i.dot(s)/a;return r.addVectors(e.origin,e.direction.clone().multiplyScalar(n)),r}},P=function(e,t){var i=new o.Vector3;i.subVectors(e.origin,t.origin);var s=t.direction.clone(),r=e.direction.clone(),a=i.dot(s),n=s.dot(r),c=i.dot(r),h=s.dot(s),l=r.dot(r)*h-n*n;if(!(Math.abs(l)<=1e-4))return(a*n-c*h)/l},j=function(e,t,i){var s=e.origin.clone();s.project(t);var r=e.direction.clone().add(e.origin);r.project(t);var a=r.clone().sub(s),n=(new o.Vector2).subVectors(i,s).dot(a)/a.dot(a),c=new o.Vector2;c.addVectors(s,a.clone().multiplyScalar(n));var h=new o.Vector3(c.x,c.y,.5);h.unproject(t);var l=new o.Ray(t.position,h.sub(t.position).normalize());return P(e,l)};class L extends o.Object3D{constructor(e){super(),this.type="CloseCloud",this.options=e||{},this.url=e.url,this.streamType=e.streamType||"vp8",this.f=e.f||526,this.maxDepthPerTile=e.maxDepthPerTile||1,this.pointSize=e.pointSize||3,this.width=e.width||1024,this.height=e.height||1024,this.resolutionFactor=Math.max(this.width,this.height)/1024,this.whiteness=e.whiteness||0,this.varianceThreshold=e.varianceThreshold||16667e-9,this.isMjpeg="mjpeg"===this.streamType.toLowerCase(),this.video=document.createElement(this.isMjpeg?"img":"video"),this.video.width=this.width,this.video.height=this.height,this.video.addEventListener(this.isMjpeg?"load":"loadedmetadata",this.metaLoaded.bind(this),!1),this.isMjpeg||(this.video.loop=!0),this.video.src=this.url,this.video.crossOrigin="Anonymous",this.video.setAttribute("crossorigin","Anonymous"),this.vertex_shader=["uniform sampler2D map;","","uniform float width;","uniform float height;","","uniform float pointSize;","uniform float zOffset;","","uniform float focallength;","uniform float maxDepthPerTile;","uniform float resolutionFactor;","","varying vec2 vUvP;","varying vec2 colorP;","","varying float depthVariance;","varying float maskVal;","","float sampleDepth(vec2 pos)","  {","    float depth;","    ","    vec2 vUv = vec2( pos.x / (width*2.0), pos.y / (height*2.0)+0.5 );","    vec2 vUv2 = vec2( pos.x / (width*2.0)+0.5, pos.y / (height*2.0)+0.5 );","    ","    vec4 depthColor = texture2D( map, vUv );","    ","    depth = ( depthColor.r + depthColor.g + depthColor.b ) / 3.0;","    ","    if (depth > (1.0 - 3.0/255.0) )","    {","      vec4 depthColor2 = texture2D( map, vUv2 );","      float depth2 = ( depthColor2.r + depthColor2.g + depthColor2.b ) / 3.0 ;","      depth += depth2;","    }","    ","    return depth;","  }","","float median(float a, float b, float c)","  {","    float r=a;","    ","    if ( (a<b) && (b<c) )","    {","      r = b;","    }","    if ( (a<c) && (c<b) )","    {","      r = c;","    }","    return r;","  }","","float variance(float d1, float d2, float d3, float d4, float d5, float d6, float d7, float d8, float d9)","  {","    float mean = (d1 + d2 + d3 + d4 + d5 + d6 + d7 + d8 + d9) / 9.0;","    float t1 = (d1-mean);","    float t2 = (d2-mean);","    float t3 = (d3-mean);","    float t4 = (d4-mean);","    float t5 = (d5-mean);","    float t6 = (d6-mean);","    float t7 = (d7-mean);","    float t8 = (d8-mean);","    float t9 = (d9-mean);","    float v = (t1*t1+t2*t2+t3*t3+t4*t4+t5*t5+t6*t6+t7*t7+t8*t8+t9*t9)/9.0;","    return v;","  }","","vec2 decodeDepth(vec2 pos)","  {","    vec2 ret;","    ","    ","    float depth1 = sampleDepth(vec2(position.x-1.0, position.y-1.0));","    float depth2 = sampleDepth(vec2(position.x, position.y-1.0));","    float depth3 = sampleDepth(vec2(position.x+1.0, position.y-1.0));","    float depth4 = sampleDepth(vec2(position.x-1.0, position.y));","    float depth5 = sampleDepth(vec2(position.x, position.y));","    float depth6 = sampleDepth(vec2(position.x+1.0, position.y));","    float depth7 = sampleDepth(vec2(position.x-1.0, position.y+1.0));","    float depth8 = sampleDepth(vec2(position.x, position.y+1.0));","    float depth9 = sampleDepth(vec2(position.x+1.0, position.y+1.0));","    ","    float median1 = median(depth1, depth2, depth3);","    float median2 = median(depth4, depth5, depth6);","    float median3 = median(depth7, depth8, depth9);","    ","    ret.x = median(median1, median2, median3);","    ret.y = variance(depth1, depth2, depth3, depth4, depth5, depth6, depth7, depth8, depth9);","    ","    return ret;","    ","  }","","","void main() {","  ","  vUvP = vec2( position.x / (width*2.0), position.y / (height*2.0)+0.5 );","  colorP = vec2( position.x / (width*2.0)+0.5 , position.y / (height*2.0)  );","  ","  vec4 pos = vec4(0.0,0.0,0.0,0.0);","  depthVariance = 0.0;","  ","  if ( (vUvP.x<0.0)|| (vUvP.x>0.5) || (vUvP.y<0.5) || (vUvP.y>0.0))","  {","    vec2 smp = decodeDepth(vec2(position.x, position.y));","    float depth = smp.x;","    depthVariance = smp.y;","    ","    float z = -depth;","    ","    pos = vec4(","      ( position.x / width - 0.5 ) * z * 0.5 * maxDepthPerTile * resolutionFactor * (1000.0/focallength) * -1.0,","      ( position.y / height - 0.5 ) * z * 0.5 * maxDepthPerTile * resolutionFactor * (1000.0/focallength),","      (- z + zOffset / 1000.0) * maxDepthPerTile,","      1.0);","    ","    vec2 maskP = vec2( position.x / (width*2.0), position.y / (height*2.0)  );","    vec4 maskColor = texture2D( map, maskP );","    maskVal = ( maskColor.r + maskColor.g + maskColor.b ) / 3.0 ;","  }","  ","  gl_PointSize = pointSize;","  gl_Position = projectionMatrix * modelViewMatrix * pos;","  ","}"].join("\n"),this.fragment_shader=["uniform sampler2D map;","uniform float varianceThreshold;","uniform float whiteness;","","varying vec2 vUvP;","varying vec2 colorP;","","varying float depthVariance;","varying float maskVal;","","","void main() {","  ","  vec4 color;","  ","  if ( (depthVariance>varianceThreshold) || (maskVal>0.5) ||(vUvP.x<0.0)|| (vUvP.x>0.5) || (vUvP.y<0.5) || (vUvP.y>1.0))","  {  ","    discard;","  }","  else ","  {","    color = texture2D( map, colorP );","    ","    float fader = whiteness /100.0;","    ","    color.r = color.r * (1.0-fader)+ fader;","    ","    color.g = color.g * (1.0-fader)+ fader;","    ","    color.b = color.b * (1.0-fader)+ fader;","    ","    color.a = 1.0;//smoothstep( 20000.0, -20000.0, gl_FragCoord.z / gl_FragCoord.w );","  }","  ","  gl_FragColor = vec4( color.r, color.g, color.b, color.a );","  ","}"].join("\n")}clone(e,t){return void 0===e&&(e=new L(this.options)),o.Object3D.prototype.clone.call(this,e,t),e}metaLoaded(){this.metaLoaded=!0,this.initStreamer()}initStreamer(){if(this.metaLoaded){this.dctexture=new o.Texture(this.video),this.dcgeometry=new o.Geometry;for(var e=this.width/2,t=this.height/2,i=0,s=e*t;i<s;i++){var r=new o.Vector3;r.x=i%e,r.y=Math.floor(i/e),this.dcgeometry.vertices.push(r)}this.dcmaterial=new o.ShaderMaterial({uniforms:{map:{type:"t",value:this.dctexture},width:{type:"f",value:e},height:{type:"f",value:t},focallength:{type:"f",value:this.f},pointSize:{type:"f",value:this.pointSize},zOffset:{type:"f",value:0},whiteness:{type:"f",value:this.whiteness},varianceThreshold:{type:"f",value:this.varianceThreshold},maxDepthPerTile:{type:"f",value:this.maxDepthPerTile},resolutionFactor:{type:"f",value:this.resolutionFactor}},vertexShader:this.vertex_shader,fragmentShader:this.fragment_shader}),this.dcmaterial.color=new o.Color(16777215),this.mesh=new o.PointCloud(this.dcgeometry,this.dcmaterial),this.mesh.frustumCulled=!1,this.mesh.position.set(0,0,0),this.add(this.mesh);var a=this;this.interval=setInterval(function(){(a.isMjpeg||a.video.readyState===a.video.HAVE_ENOUGH_DATA)&&(a.dctexture.needsUpdate=!0)},1e3/30)}}startStream(){this.isMjpeg||this.video.play()}stopStream(){this.isMjpeg||this.video.pause(),this.video.src="",clearInterval(this.interval),this.remove(this.mesh),this.dctexture&&this.dctexture.dispose(),this.dcgeometry&&this.dcgeometry.dispose(),this.dcmaterial&&this.dcmaterial.dispose()}}class V extends o.Mesh{constructor(e){var t=(e=e||{}).origin||new o.Vector3(0,0,0),i=e.direction||new o.Vector3(1,0,0),s=e.length||1,r=e.headLength||.2,a=e.shaftDiameter||.05,n=e.headDiameter||.1,c=e.material||new o.MeshBasicMaterial,h=s-r,l=new o.CylinderGeometry(.5*a,.5*a,h,12,1),d=new o.Matrix4;d.setPosition(new o.Vector3(0,.5*h,0)),l.applyMatrix(d);var p=new o.CylinderGeometry(0,.5*n,r,12,1);d.setPosition(new o.Vector3(0,h+.5*r,0)),p.applyMatrix(d),l.merge(p),super(l,c),this.position.copy(t),this.setDirection(i)}setDirection(e){var t=new o.Vector3(0,1,0).cross(e),i=Math.acos(new o.Vector3(0,1,0).dot(e.clone().normalize()));this.matrix=(new o.Matrix4).makeRotationAxis(t.normalize(),i),this.rotation.setFromRotationMatrix(this.matrix,this.rotation.order)}setLength(e){this.scale.set(e,e,e)}setColor(e){this.material.color.setHex(e)}dispose(){void 0!==this.geometry&&this.geometry.dispose(),void 0!==this.material&&this.material.dispose()}}o.STLLoader=function(e){this.manager=void 0!==e?e:o.DefaultLoadingManager},o.STLLoader.prototype={constructor:o.STLLoader,load:function(e,t,i,s){var r=this,a=new o.FileLoader(r.manager);a.setResponseType("arraybuffer"),a.load(e,function(e){t(r.parse(e))},i,s)},parse:function(e){var t=function(e){if("string"==typeof e){for(var t=new Uint8Array(e.length),i=0;i<e.length;i++)t[i]=255&e.charCodeAt(i);return t.buffer||t}return e}(e);return function(e){var t;if(84+50*(t=new DataView(e)).getUint32(80,!0)===t.byteLength)return!0;for(var i=[115,111,108,105,100],s=0;s<5;s++)if(i[s]!=t.getUint8(s,!1))return!0;return!1}(t)?function(e){for(var t,i,s,r,a,n,c,h,l=new DataView(e),d=l.getUint32(80,!0),p=!1,u=0;u<70;u++)1129270351==l.getUint32(u,!1)&&82==l.getUint8(u+4)&&61==l.getUint8(u+5)&&(p=!0,r=[],a=l.getUint8(u+6)/255,n=l.getUint8(u+7)/255,c=l.getUint8(u+8)/255,h=l.getUint8(u+9)/255);for(var m=new o.BufferGeometry,f=[],v=[],g=0;g<d;g++){var b=84+50*g,y=l.getFloat32(b,!0),w=l.getFloat32(b+4,!0),x=l.getFloat32(b+8,!0);if(p){var T=l.getUint16(b+48,!0);0==(32768&T)?(t=(31&T)/31,i=(T>>5&31)/31,s=(T>>10&31)/31):(t=a,i=n,s=c)}for(var E=1;E<=3;E++){var M=b+12*E;f.push(l.getFloat32(M,!0)),f.push(l.getFloat32(M+4,!0)),f.push(l.getFloat32(M+8,!0)),v.push(y,w,x),p&&r.push(t,i,s)}}return m.addAttribute("position",new o.BufferAttribute(new Float32Array(f),3)),m.addAttribute("normal",new o.BufferAttribute(new Float32Array(v),3)),p&&(m.addAttribute("color",new o.BufferAttribute(new Float32Array(r),3)),m.hasColors=!0,m.alpha=h),m}(t):function(e){for(var t,i=new o.BufferGeometry,s=/facet([\s\S]*?)endfacet/g,r=0,a=/[\s]+([+-]?(?:\d+.\d+|\d+.|\d+|.\d+)(?:[eE][+-]?\d+)?)/.source,n=new RegExp("vertex"+a+a+a,"g"),c=new RegExp("normal"+a+a+a,"g"),h=[],l=[],d=new o.Vector3;null!==(t=s.exec(e));){for(var p=0,u=0,m=t[0];null!==(t=c.exec(m));)d.x=parseFloat(t[1]),d.y=parseFloat(t[2]),d.z=parseFloat(t[3]),u++;for(;null!==(t=n.exec(m));)h.push(parseFloat(t[1]),parseFloat(t[2]),parseFloat(t[3])),l.push(d.x,d.y,d.z),p++;1!==u&&console.error("THREE.STLLoader: Something isn't right with the normal of face number "+r),3!==p&&console.error("THREE.STLLoader: Something isn't right with the vertices of face number "+r),r++}return i.addAttribute("position",new o.Float32BufferAttribute(h,3)),i.addAttribute("normal",new o.Float32BufferAttribute(l,3)),i}(function(e){if("string"!=typeof e){var t=new Uint8Array(e);if(void 0!==window.TextDecoder)return(new TextDecoder).decode(t);for(var i="",s=0,o=e.byteLength;s<o;s++)i+=String.fromCharCode(t[s]);return i}return e}(e))}},o.ColladaLoader=function(e){this.manager=void 0!==e?e:o.DefaultLoadingManager},o.ColladaLoader.prototype={constructor:o.ColladaLoader,crossOrigin:"Anonymous",load:function(e,t,i,s){var r=this,a=o.Loader.prototype.extractUrlBase(e);new o.FileLoader(r.manager).load(e,function(e){t(r.parse(e,a))},i,s)},options:{set convertUpAxis(e){console.warn("THREE.ColladaLoader: options.convertUpAxis() has been removed. Up axis is converted automatically.")}},setCrossOrigin:function(e){this.crossOrigin=e},parse:function(e,t){function i(e,t){for(var i=[],s=e.childNodes,o=0,r=s.length;o<r;o++){var a=s[o];a.nodeName===t&&i.push(a)}return i}function s(e){if(0===e.length)return[];for(var t=e.trim().split(/\s+/),i=new Array(t.length),s=0,o=t.length;s<o;s++)i[s]=t[s];return i}function r(e){if(0===e.length)return[];for(var t=e.trim().split(/\s+/),i=new Array(t.length),s=0,o=t.length;s<o;s++)i[s]=parseFloat(t[s]);return i}function a(e){if(0===e.length)return[];for(var t=e.trim().split(/\s+/),i=new Array(t.length),s=0,o=t.length;s<o;s++)i[s]=parseInt(t[s]);return i}function n(e){return e.substring(1)}function c(e){return 0===Object.keys(e).length}function h(e,t,s,o){var r=i(e,t)[0];if(void 0!==r)for(var a=i(r,s),n=0;n<a.length;n++)o(a[n])}function l(e,t){for(var i in e){e[i].build=t(e[i])}}function d(e,t){return void 0!==e.build?e.build:(e.build=t(e),e.build)}function p(e){for(var t={inputs:{}},i=0,s=e.childNodes.length;i<s;i++){var o=e.childNodes[i];if(1===o.nodeType)switch(o.nodeName){case"input":var r=n(o.getAttribute("source")),a=o.getAttribute("semantic");t.inputs[a]=r}}return t}function u(e){var t={},i=e.getAttribute("target").split("/"),s=i.shift(),o=i.shift(),r=-1!==o.indexOf("("),a=-1!==o.indexOf(".");if(a)o=(i=o.split(".")).shift(),t.member=i.shift();else if(r){var c=o.split("(");o=c.shift();for(var h=0;h<c.length;h++)c[h]=parseInt(c[h].replace(/\)/,""));t.indices=c}return t.id=s,t.sid=o,t.arraySyntax=r,t.memberSyntax=a,t.sampler=n(e.getAttribute("source")),t}function m(e){var t=[],i=e.channels,s=e.samplers,o=e.sources;for(var r in i)if(i.hasOwnProperty(r)){var a=i[r],n=s[a.sampler],c=n.inputs.INPUT,h=n.inputs.OUTPUT;w(v(a,o[c],o[h]),t)}return t}function f(e){return d(Pe.animations[e],m)}function v(e,t,i){var s,o,r,a,n,c,h=Pe.nodes[e.id],l=Ee(h.id),d=h.transforms[e.sid],p=h.matrix.clone().transpose(),u={};switch(d){case"matrix":for(r=0,a=t.array.length;r<a;r++)if(s=t.array[r],o=r*i.stride,void 0===u[s]&&(u[s]={}),!0===e.arraySyntax){var m=i.array[o],f=e.indices[0]+4*e.indices[1];u[s][f]=m}else for(n=0,c=i.stride;n<c;n++)u[s][n]=i.array[o+n];break;case"translate":case"rotate":case"scale":console.warn('THREE.ColladaLoader: Animation transform type "%s" not yet implemented.',d)}var v=function(e,t){var i=[];for(var s in e)i.push({time:parseFloat(s),value:e[s]});i.sort(function(e,t){return e.time-t.time});for(var o=0;o<16;o++)x(i,o,t.elements[o]);return i}(u,p);return{name:l.uuid,keyframes:v}}var g=new o.Vector3,b=new o.Vector3,y=new o.Quaternion;function w(e,t){for(var i=e.keyframes,s=e.name,r=[],a=[],n=[],c=[],h=0,l=i.length;h<l;h++){var d=i[h],p=d.time,u=d.value;me.fromArray(u).transpose(),me.decompose(g,y,b),r.push(p),a.push(g.x,g.y,g.z),n.push(y.x,y.y,y.z,y.w),c.push(b.x,b.y,b.z)}return a.length>0&&t.push(new o.VectorKeyframeTrack(s+".position",r,a)),n.length>0&&t.push(new o.QuaternionKeyframeTrack(s+".quaternion",r,n)),c.length>0&&t.push(new o.VectorKeyframeTrack(s+".scale",r,c)),t}function x(e,t,i){var s,o,r,a=!0;for(o=0,r=e.length;o<r;o++)void 0===(s=e[o]).value[t]?s.value[t]=null:a=!1;if(!0===a)for(o=0,r=e.length;o<r;o++)(s=e[o]).value[t]=i;else!function(e,t){for(var i,s,o=0,r=e.length;o<r;o++){var a=e[o];if(null===a.value[t]){if(i=T(e,o,t),s=E(e,o,t),null===i){a.value[t]=s.value[t];continue}if(null===s){a.value[t]=i.value[t];continue}M(a,i,s,t)}}}(e,t)}function T(e,t,i){for(;t>=0;){var s=e[t];if(null!==s.value[i])return s;t--}return null}function E(e,t,i){for(;t<e.length;){var s=e[t];if(null!==s.value[i])return s;t++}return null}function M(e,t,i,s){i.time-t.time!=0?e.value[s]=(e.time-t.time)*(i.value[s]-t.value[s])/(i.time-t.time)+t.value[s]:e.value[s]=t.value[s]}function k(e){for(var t=[],i=e.name,s=e.end-e.start||-1,r=e.animations,a=0,n=r.length;a<n;a++)for(var c=f(r[a]),h=0,l=c.length;h<l;h++)t.push(c[h]);return new o.AnimationClip(i,s,t)}function C(e){return d(Pe.clips[e],k)}function A(e){for(var t={sources:{}},i=0,s=e.childNodes.length;i<s;i++){var o=e.childNodes[i];if(1===o.nodeType)switch(o.nodeName){case"bind_shape_matrix":t.bindShapeMatrix=r(o.textContent);break;case"source":var a=o.getAttribute("id");t.sources[a]=J(o);break;case"joints":t.joints=N(o);break;case"vertex_weights":t.vertexWeights=O(o)}}return t}function N(e){for(var t={inputs:{}},i=0,s=e.childNodes.length;i<s;i++){var o=e.childNodes[i];if(1===o.nodeType)switch(o.nodeName){case"input":var r=o.getAttribute("semantic"),a=n(o.getAttribute("source"));t.inputs[r]=a}}return t}function O(e){for(var t={inputs:{}},i=0,s=e.childNodes.length;i<s;i++){var o=e.childNodes[i];if(1===o.nodeType)switch(o.nodeName){case"input":var r=o.getAttribute("semantic"),c=n(o.getAttribute("source")),h=parseInt(o.getAttribute("offset"));t.inputs[r]={id:c,offset:h};break;case"vcount":t.vcount=a(o.textContent);break;case"v":t.v=a(o.textContent)}}return t}function _(e){var t={id:e.id},i=Pe.geometries[t.id];return void 0!==e.skin&&(t.skin=function(e){var t,i,s,r={joints:[],indices:{array:[],stride:4},weights:{array:[],stride:4}},a=e.sources,n=e.vertexWeights,c=n.vcount,h=n.v,l=n.inputs.JOINT.offset,d=n.inputs.WEIGHT.offset,p=e.sources[e.joints.inputs.JOINT],u=e.sources[e.joints.inputs.INV_BIND_MATRIX],m=a[n.inputs.WEIGHT.id].array,f=0;for(t=0,s=c.length;t<s;t++){var v=c[t],g=[];for(i=0;i<v;i++){var b=h[f+l],y=h[f+d],w=m[y];g.push({index:b,weight:w}),f+=2}for(g.sort(M),i=0;i<4;i++){var x=g[i];void 0!==x?(r.indices.array.push(x.index),r.weights.array.push(x.weight)):(r.indices.array.push(0),r.weights.array.push(0))}}for(r.bindMatrix=(new o.Matrix4).fromArray(e.bindShapeMatrix).transpose(),t=0,s=p.array.length;t<s;t++){var T=p.array[t],E=(new o.Matrix4).fromArray(u.array,t*u.stride).transpose();r.joints.push({name:T,boneInverse:E})}return r;function M(e,t){return t.weight-e.weight}}(e.skin),i.sources.skinIndices=t.skin.indices,i.sources.skinWeights=t.skin.weights),t}function R(e){return void 0!==e.build?e.build:e.init_from}function D(e){for(var t={surfaces:{},samplers:{}},i=0,s=e.childNodes.length;i<s;i++){var o=e.childNodes[i];if(1===o.nodeType)switch(o.nodeName){case"newparam":S(o,t);break;case"technique":t.technique=L(o)}}return t}function S(e,t){for(var i=e.getAttribute("sid"),s=0,o=e.childNodes.length;s<o;s++){var r=e.childNodes[s];if(1===r.nodeType)switch(r.nodeName){case"surface":t.surfaces[i]=P(r);break;case"sampler2D":t.samplers[i]=j(r)}}}function P(e){for(var t={},i=0,s=e.childNodes.length;i<s;i++){var o=e.childNodes[i];if(1===o.nodeType)switch(o.nodeName){case"init_from":t.init_from=o.textContent}}return t}function j(e){for(var t={},i=0,s=e.childNodes.length;i<s;i++){var o=e.childNodes[i];if(1===o.nodeType)switch(o.nodeName){case"source":t.source=o.textContent}}return t}function L(e){for(var t={},i=0,s=e.childNodes.length;i<s;i++){var o=e.childNodes[i];if(1===o.nodeType)switch(o.nodeName){case"constant":case"lambert":case"blinn":case"phong":t.type=o.nodeName,t.parameters=V(o)}}return t}function V(e){for(var t={},i=0,s=e.childNodes.length;i<s;i++){var o=e.childNodes[i];if(1===o.nodeType)switch(o.nodeName){case"emission":case"diffuse":case"specular":case"shininess":case"transparent":case"transparency":t[o.nodeName]=I(o)}}return t}function I(e){for(var t={},i=0,s=e.childNodes.length;i<s;i++){var o=e.childNodes[i];if(1===o.nodeType)switch(o.nodeName){case"color":t[o.nodeName]=r(o.textContent);break;case"float":t[o.nodeName]=parseFloat(o.textContent);break;case"texture":t[o.nodeName]={id:o.getAttribute("texture"),extra:z(o)}}}return t}function z(e){for(var t={technique:{}},i=0,s=e.childNodes.length;i<s;i++){var o=e.childNodes[i];if(1===o.nodeType)switch(o.nodeName){case"extra":F(o,t)}}return t}function F(e,t){for(var i=0,s=e.childNodes.length;i<s;i++){var o=e.childNodes[i];if(1===o.nodeType)switch(o.nodeName){case"technique":U(o,t)}}}function U(e,t){for(var i=0,s=e.childNodes.length;i<s;i++){var o=e.childNodes[i];if(1===o.nodeType)switch(o.nodeName){case"repeatU":case"repeatV":case"offsetU":case"offsetV":t.technique[o.nodeName]=parseFloat(o.textContent);break;case"wrapU":case"wrapV":"TRUE"===o.textContent.toUpperCase()?t.technique[o.nodeName]=1:"FALSE"===o.textContent.toUpperCase()?t.technique[o.nodeName]=0:t.technique[o.nodeName]=parseInt(o.textContent)}}}function B(e){return e}function G(e){var t,i,s=(t=e.url,d(Pe.effects[t],B)),r=s.profile.technique;switch(r.type){case"phong":case"blinn":i=new o.MeshPhongMaterial;break;case"lambert":i=new o.MeshLambertMaterial;break;default:i=new o.MeshBasicMaterial}function a(e){var t,i=s.profile.samplers[e.id];if(void 0!==i){var r=s.profile.surfaces[i.source],a=_e.load((t=r.init_from,d(Pe.images[t],R))),n=e.extra;if(void 0!==n&&void 0!==n.technique&&!1===c(n.technique)){var h=n.technique;a.wrapS=h.wrapU?o.RepeatWrapping:o.ClampToEdgeWrapping,a.wrapT=h.wrapV?o.RepeatWrapping:o.ClampToEdgeWrapping,a.offset.set(h.offsetU||0,h.offsetV||0),a.repeat.set(h.repeatU||1,h.repeatV||1)}else a.wrapS=o.RepeatWrapping,a.wrapT=o.RepeatWrapping;return a}return console.error("THREE.ColladaLoader: Undefined sampler",e.id),null}i.name=e.name;var n=r.parameters;for(var h in n){var l=n[h];switch(h){case"diffuse":l.color&&i.color.fromArray(l.color),l.texture&&(i.map=a(l.texture));break;case"specular":l.color&&i.specular&&i.specular.fromArray(l.color),l.texture&&(i.specularMap=a(l.texture));break;case"shininess":l.float&&i.shininess&&(i.shininess=l.float);break;case"emission":l.color&&i.emissive&&i.emissive.fromArray(l.color);break;case"transparent":i.transparent=!0;break;case"transparency":void 0!==l.float&&(i.opacity=l.float),i.transparent=!0}}return i}function q(e){return d(Pe.materials[e],G)}function H(e){for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];switch(i.nodeName){case"technique_common":return W(i)}}return{}}function W(e){for(var t={},i=0;i<e.childNodes.length;i++){var s=e.childNodes[i];switch(s.nodeName){case"perspective":case"orthographic":t.technique=s.nodeName,t.parameters=K(s)}}return t}function K(e){for(var t={},i=0;i<e.childNodes.length;i++){var s=e.childNodes[i];switch(s.nodeName){case"xfov":case"yfov":case"xmag":case"ymag":case"znear":case"zfar":case"aspect_ratio":t[s.nodeName]=parseFloat(s.textContent)}}return t}function Q(e){var t;switch(e.optics.technique){case"perspective":t=new o.PerspectiveCamera(e.optics.parameters.yfov,e.optics.parameters.aspect_ratio,e.optics.parameters.znear,e.optics.parameters.zfar);break;case"orthographic":var i=e.optics.parameters.ymag,s=e.optics.parameters.xmag,r=e.optics.parameters.aspect_ratio;s=void 0===s?i*r:s,i=void 0===i?s/r:i,s*=.5,i*=.5,t=new o.OrthographicCamera(-s,s,i,-i,e.optics.parameters.znear,e.optics.parameters.zfar);break;default:t=new o.PerspectiveCamera}return t.name=e.name,t}function X(e){var t=Pe.cameras[e];return void 0!==t?d(t,Q):null}function Z(e){for(var t={},i=0,s=e.childNodes.length;i<s;i++){var o=e.childNodes[i];if(1===o.nodeType)switch(o.nodeName){case"directional":case"point":case"spot":case"ambient":t.technique=o.nodeName,t.parameters=Y(o)}}return t}function Y(e){for(var t={},i=0,s=e.childNodes.length;i<s;i++){var a=e.childNodes[i];if(1===a.nodeType)switch(a.nodeName){case"color":var n=r(a.textContent);t.color=(new o.Color).fromArray(n);break;case"falloff_angle":t.falloffAngle=parseFloat(a.textContent);break;case"quadratic_attenuation":var c=parseFloat(a.textContent);t.distance=c?Math.sqrt(1/c):0}}return t}function J(e){for(var t={array:[],stride:3},o=0;o<e.childNodes.length;o++){var a=e.childNodes[o];if(1===a.nodeType)switch(a.nodeName){case"float_array":t.array=r(a.textContent);break;case"Name_array":t.array=s(a.textContent);break;case"technique_common":var n=i(a,"accessor")[0];void 0!==n&&(t.stride=parseInt(n.getAttribute("stride")))}}return t}function $(e){for(var t={},i=0;i<e.childNodes.length;i++){var s=e.childNodes[i];1===s.nodeType&&(t[s.getAttribute("semantic")]=n(s.getAttribute("source")))}return t}function ee(e){for(var t={type:e.nodeName,material:e.getAttribute("material"),count:parseInt(e.getAttribute("count")),inputs:{},stride:0},i=0,s=e.childNodes.length;i<s;i++){var o=e.childNodes[i];if(1===o.nodeType)switch(o.nodeName){case"input":var r=n(o.getAttribute("source")),c=o.getAttribute("semantic"),h=parseInt(o.getAttribute("offset"));t.inputs[c]={id:r,offset:h},t.stride=Math.max(t.stride,h+1);break;case"vcount":t.vcount=a(o.textContent);break;case"p":t.p=a(o.textContent)}}return t}function te(e){var t={},i=e.sources,s=e.vertices,o=e.primitives;if(0===o.length)return{};var r=function(e){for(var t={},i=0;i<e.length;i++){var s=e[i];void 0===t[s.type]&&(t[s.type]=[]),t[s.type].push(s)}return t}(o);for(var a in r)t[a]=ie(r[a],i,s);return t}function ie(e,t,i){for(var s={},r={array:[],stride:0},a={array:[],stride:0},n={array:[],stride:0},c={array:[],stride:0},h=[],l=4,d=[],p=4,u=new o.BufferGeometry,m=[],f=0,v=0,g=0;g<e.length;g++){var b=e[g],y=b.inputs,w=1;for(var x in b.vcount&&4===b.vcount[0]&&(w=2),v="lines"===b.type||"linestrips"===b.type?2*b.count:3*b.count*w,u.addGroup(f,v,g),f+=v,b.material&&m.push(b.material),y){var T=y[x];switch(x){case"VERTEX":for(var E in i){var M=i[E];switch(E){case"POSITION":se(b,t[M],T.offset,r.array),r.stride=t[M].stride,t.skinWeights&&t.skinIndices&&(se(b,t.skinIndices,T.offset,h),se(b,t.skinWeights,T.offset,d));break;case"NORMAL":se(b,t[M],T.offset,a.array),a.stride=t[M].stride;break;case"COLOR":se(b,t[M],T.offset,c.array),c.stride=t[M].stride;break;case"TEXCOORD":se(b,t[M],T.offset,n.array),n.stride=t[M].stride;break;default:console.warn('THREE.ColladaLoader: Semantic "%s" not handled in geometry build process.',E)}}break;case"NORMAL":se(b,t[T.id],T.offset,a.array),a.stride=t[T.id].stride;break;case"COLOR":se(b,t[T.id],T.offset,c.array),c.stride=t[T.id].stride;break;case"TEXCOORD":se(b,t[T.id],T.offset,n.array),n.stride=t[T.id].stride}}}return r.array.length>0&&u.addAttribute("position",new o.Float32BufferAttribute(r.array,r.stride)),a.array.length>0&&u.addAttribute("normal",new o.Float32BufferAttribute(a.array,a.stride)),c.array.length>0&&u.addAttribute("color",new o.Float32BufferAttribute(c.array,c.stride)),n.array.length>0&&u.addAttribute("uv",new o.Float32BufferAttribute(n.array,n.stride)),h.length>0&&u.addAttribute("skinIndex",new o.Float32BufferAttribute(h,l)),d.length>0&&u.addAttribute("skinWeight",new o.Float32BufferAttribute(d,p)),s.data=u,s.type=e[0].type,s.materialKeys=m,s}function se(e,t,i,s){var o=e.p,r=e.stride,a=e.vcount;function n(e){for(var t=o[e+i]*l,r=t+l;t<r;t++)s.push(h[t])}var c=0,h=t.array,l=t.stride;if(void 0!==e.vcount){for(var d=0,p=0,u=a.length;p<u;p++){var m=a[p];if(4===m){var f=d+1*r,v=d+2*r,g=d+3*r;n(d+0*r),n(f),n(g),n(f),n(v),n(g)}else if(3===m){f=d+1*r,v=d+2*r;n(d+0*r),n(f),n(v)}else c=Math.max(c,m);d+=r*m}c>0&&console.log("THREE.ColladaLoader: Geometry has faces with more than 4 vertices.")}else for(p=0,u=o.length;p<u;p+=r)n(p)}function oe(e){return d(Pe.geometries[e],te)}function re(e){return void 0!==e.build?e.build:e}function ae(e,t){for(var i=0;i<e.childNodes.length;i++){var s=e.childNodes[i];if(1===s.nodeType)switch(s.nodeName){case"joint":t.joints[s.getAttribute("sid")]=ne(s);break;case"link":t.links.push(he(s))}}}function ne(e){for(var t,i=0;i<e.childNodes.length;i++){var s=e.childNodes[i];if(1===s.nodeType)switch(s.nodeName){case"prismatic":case"revolute":t=ce(s)}}return t}function ce(e,t){t={sid:e.getAttribute("sid"),name:e.getAttribute("name")||"",axis:new o.Vector3,limits:{min:0,max:0},type:e.nodeName,static:!1,zeroPosition:0,middlePosition:0};for(var i=0;i<e.childNodes.length;i++){var s=e.childNodes[i];if(1===s.nodeType)switch(s.nodeName){case"axis":var a=r(s.textContent);t.axis.fromArray(a);break;case"limits":var n=s.getElementsByTagName("max")[0],c=s.getElementsByTagName("min")[0];t.limits.max=parseFloat(n.textContent),t.limits.min=parseFloat(c.textContent)}}return t.limits.min>=t.limits.max&&(t.static=!0),t.middlePosition=(t.limits.min+t.limits.max)/2,t}function he(e){for(var t={sid:e.getAttribute("sid"),name:e.getAttribute("name")||"",attachments:[],transforms:[]},i=0;i<e.childNodes.length;i++){var s=e.childNodes[i];if(1===s.nodeType)switch(s.nodeName){case"attachment_full":t.attachments.push(le(s));break;case"matrix":case"translate":case"rotate":t.transforms.push(de(s))}}return t}function le(e){for(var t={joint:e.getAttribute("joint").split("/").pop(),transforms:[],links:[]},i=0;i<e.childNodes.length;i++){var s=e.childNodes[i];if(1===s.nodeType)switch(s.nodeName){case"link":t.links.push(he(s));break;case"matrix":case"translate":case"rotate":t.transforms.push(de(s))}}return t}function de(e){var t={type:e.nodeName},i=r(e.textContent);switch(t.type){case"matrix":t.obj=new o.Matrix4,t.obj.fromArray(i).transpose();break;case"translate":t.obj=new o.Vector3,t.obj.fromArray(i);break;case"rotate":t.obj=new o.Vector3,t.obj.fromArray(i),t.angle=o.Math.degToRad(i[3])}return t}function pe(e){for(var t={target:e.getAttribute("target").split("/").pop()},i=0;i<e.childNodes.length;i++){var s=e.childNodes[i];if(1===s.nodeType)switch(s.nodeName){case"axis":var o=s.getElementsByTagName("param")[0];t.axis=o.textContent;var r=t.axis.split("inst_").pop().split("axis")[0];t.jointIndex=r.substr(0,r.length-1)}}return t}function ue(e){return void 0!==e.build?e.build:e}var me=new o.Matrix4,fe=new o.Vector3;function ve(e){for(var t={name:e.getAttribute("name")||"",type:e.getAttribute("type"),id:e.getAttribute("id"),sid:e.getAttribute("sid"),matrix:new o.Matrix4,nodes:[],instanceCameras:[],instanceControllers:[],instanceLights:[],instanceGeometries:[],instanceNodes:[],transforms:{}},i=0;i<e.childNodes.length;i++){var s=e.childNodes[i];if(1===s.nodeType)switch(s.nodeName){case"node":t.nodes.push(s.getAttribute("id")),ve(s);break;case"instance_camera":t.instanceCameras.push(n(s.getAttribute("url")));break;case"instance_controller":t.instanceControllers.push(ge(s));break;case"instance_light":t.instanceLights.push(n(s.getAttribute("url")));break;case"instance_geometry":t.instanceGeometries.push(ge(s));break;case"instance_node":t.instanceNodes.push(n(s.getAttribute("url")));break;case"matrix":var a=r(s.textContent);t.matrix.multiply(me.fromArray(a).transpose()),t.transforms[s.getAttribute("sid")]=s.nodeName;break;case"translate":a=r(s.textContent);fe.fromArray(a),t.matrix.multiply(me.makeTranslation(fe.x,fe.y,fe.z)),t.transforms[s.getAttribute("sid")]=s.nodeName;break;case"rotate":a=r(s.textContent);var c=o.Math.degToRad(a[3]);t.matrix.multiply(me.makeRotationAxis(fe.fromArray(a),c)),t.transforms[s.getAttribute("sid")]=s.nodeName;break;case"scale":a=r(s.textContent);t.matrix.scale(fe.fromArray(a)),t.transforms[s.getAttribute("sid")]=s.nodeName;break;case"extra":break;default:console.log(s)}}return Pe.nodes[t.id]=t,t}function ge(e){for(var t={id:n(e.getAttribute("url")),materials:{},skeletons:[]},i=0;i<e.childNodes.length;i++){var s=e.childNodes[i];switch(s.nodeName){case"bind_material":for(var o=s.getElementsByTagName("instance_material"),r=0;r<o.length;r++){var a=o[r],c=a.getAttribute("symbol"),h=a.getAttribute("target");t.materials[c]=n(h)}break;case"skeleton":t.skeletons.push(n(s.textContent))}}return t}function be(e,t){var i,s,r,a=[],n=[];for(i=0;i<e.length;i++){ye(Ee(e[i]),t,a)}for(i=0;i<t.length;i++)for(s=0;s<a.length;s++)if((r=a[s]).bone.name===t[i].name){n[i]=r,r.processed=!0;break}for(i=0;i<a.length;i++)!1===(r=a[i]).processed&&(n.push(r),r.processed=!0);var c=[],h=[];for(i=0;i<n.length;i++)r=n[i],c.push(r.bone),h.push(r.boneInverse);return new o.Skeleton(c,h)}function ye(e,t,i){e.traverse(function(e){if(!0===e.isBone){for(var s,r=0;r<t.length;r++){var a=t[r];if(a.name===e.name){s=a.boneInverse;break}}void 0===s&&(s=new o.Matrix4),i.push({bone:e,boneInverse:s,processed:!1})}})}function we(e){for(var t,i=[],s=e.matrix,r=e.nodes,a=e.type,n=e.instanceCameras,c=e.instanceControllers,h=e.instanceLights,l=e.instanceGeometries,p=e.instanceNodes,u=0,m=r.length;u<m;u++)i.push(Ee(r[u]));for(u=0,m=n.length;u<m;u++){null!==(T=X(n[u]))&&i.push(T.clone())}for(u=0,m=c.length;u<m;u++)for(var f=c[u],v=(t=f.id,d(Pe.controllers[t],_)),g=Te(oe(v.id),f.materials),b=be(f.skeletons,v.skin.joints),y=0,w=g.length;y<w;y++){var x;(x=g[y]).isSkinnedMesh&&(x.bind(b,v.skin.bindMatrix),x.normalizeSkinWeights()),i.push(x)}for(u=0,m=h.length;u<m;u++){var T;null!==(T=X(n[u]))&&i.push(T.clone())}for(u=0,m=l.length;u<m;u++)for(y=0,w=(g=Te(oe((f=l[u]).id),f.materials)).length;y<w;y++)i.push(g[y]);for(u=0,m=p.length;u<m;u++)i.push(Ee(p[u]).clone());if(0===r.length&&1===i.length)x=i[0];else{x="JOINT"===a?new o.Bone:new o.Group;for(u=0;u<i.length;u++)x.add(i[u])}return x.name="JOINT"===a?e.sid:e.name,x.matrix.copy(s),x.matrix.decompose(x.position,x.quaternion,x.scale),x}function xe(e,t){for(var i=[],s=0,o=e.length;s<o;s++){var r=t[e[s]];i.push(q(r))}return i}function Te(e,t){var i=[];for(var s in e){var r=e[s],a=xe(r.materialKeys,t);0===a.length&&("lines"===s||"linestrips"===s?a.push(new o.LineBasicMaterial):a.push(new o.MeshPhongMaterial));var n=void 0!==r.data.attributes.skinIndex;if(n)for(var c=0,h=a.length;c<h;c++)a[c].skinning=!0;var l,d=1===a.length?a[0]:a;switch(s){case"lines":l=new o.LineSegments(r.data,d);break;case"linestrips":l=new o.Line(r.data,d);break;case"triangles":case"polylist":l=n?new o.SkinnedMesh(r.data,d):new o.Mesh(r.data,d)}i.push(l)}return i}function Ee(e){return d(Pe.nodes[e],we)}function Me(e){var t=new o.Group;t.name=e.name;for(var i=e.children,s=0;s<i.length;s++){var r=i[s];null===r.id?t.add(we(r)):t.add(Ee(r.id))}return t}function ke(e){return d(Pe.visualScenes[e],Me)}if(console.time("THREE.ColladaLoader"),0===e.length)return{scene:new o.Scene};console.time("THREE.ColladaLoader: DOMParser");var Ce=(new DOMParser).parseFromString(e,"application/xml");console.timeEnd("THREE.ColladaLoader: DOMParser");var Ae=i(Ce,"COLLADA")[0],Ne=Ae.getAttribute("version");console.log("THREE.ColladaLoader: File version",Ne);var Oe=function(e){return{unit:function(e){return void 0!==e?parseFloat(e.getAttribute("meter")):1}(i(e,"unit")[0]),upAxis:function(e){return void 0!==e?e.textContent:"Y_UP"}(i(e,"up_axis")[0])}}(i(Ae,"asset")[0]),_e=new o.TextureLoader(this.manager);_e.setPath(t).setCrossOrigin(this.crossOrigin);var Re=[],De={},Se=0,Pe={animations:{},clips:{},controllers:{},images:{},effects:{},materials:{},cameras:{},lights:{},geometries:{},nodes:{},visualScenes:{},kinematicsModels:{},kinematicsScenes:{}};console.time("THREE.ColladaLoader: Parse"),h(Ae,"library_animations","animation",function(e){for(var t={sources:{},samplers:{},channels:{}},i=0,s=e.childNodes.length;i<s;i++){var o,r=e.childNodes[i];if(1===r.nodeType)switch(r.nodeName){case"source":o=r.getAttribute("id"),t.sources[o]=J(r);break;case"sampler":o=r.getAttribute("id"),t.samplers[o]=p(r);break;case"channel":o=r.getAttribute("target"),t.channels[o]=u(r);break;default:console.log(r)}}Pe.animations[e.getAttribute("id")]=t}),h(Ae,"library_animation_clips","animation_clip",function(e){for(var t={name:e.getAttribute("id")||"default",start:parseFloat(e.getAttribute("start")||0),end:parseFloat(e.getAttribute("end")||0),animations:[]},i=0,s=e.childNodes.length;i<s;i++){var o=e.childNodes[i];if(1===o.nodeType)switch(o.nodeName){case"instance_animation":t.animations.push(n(o.getAttribute("url")))}}Pe.clips[e.getAttribute("id")]=t}),h(Ae,"library_controllers","controller",function(e){for(var t={},i=0,s=e.childNodes.length;i<s;i++){var o=e.childNodes[i];if(1===o.nodeType)switch(o.nodeName){case"skin":t.id=n(o.getAttribute("source")),t.skin=A(o);break;case"morph":t.id=n(o.getAttribute("source")),console.warn("THREE.ColladaLoader: Morph target animation not supported yet.")}}Pe.controllers[e.getAttribute("id")]=t}),h(Ae,"library_images","image",function(e){var t={init_from:i(e,"init_from")[0].textContent};Pe.images[e.getAttribute("id")]=t}),h(Ae,"library_effects","effect",function(e){for(var t={},i=0,s=e.childNodes.length;i<s;i++){var o=e.childNodes[i];if(1===o.nodeType)switch(o.nodeName){case"profile_COMMON":t.profile=D(o)}}Pe.effects[e.getAttribute("id")]=t}),h(Ae,"library_materials","material",function(e){for(var t={name:e.getAttribute("name")},i=0,s=e.childNodes.length;i<s;i++){var o=e.childNodes[i];if(1===o.nodeType)switch(o.nodeName){case"instance_effect":t.url=n(o.getAttribute("url"))}}Pe.materials[e.getAttribute("id")]=t}),h(Ae,"library_cameras","camera",function(e){for(var t={name:e.getAttribute("name")},i=0,s=e.childNodes.length;i<s;i++){var o=e.childNodes[i];if(1===o.nodeType)switch(o.nodeName){case"optics":t.optics=H(o)}}Pe.cameras[e.getAttribute("id")]=t}),h(Ae,"library_lights","light",function(e){for(var t={},i=0,s=e.childNodes.length;i<s;i++){var o=e.childNodes[i];if(1===o.nodeType)switch(o.nodeName){case"technique_common":t=Z(o)}}Pe.lights[e.getAttribute("id")]=t}),h(Ae,"library_geometries","geometry",function(e){for(var t={name:e.getAttribute("name"),sources:{},vertices:{},primitives:[]},s=i(e,"mesh")[0],o=0;o<s.childNodes.length;o++){var r=s.childNodes[o];if(1===r.nodeType){var a=r.getAttribute("id");switch(r.nodeName){case"source":t.sources[a]=J(r);break;case"vertices":t.vertices=$(r);break;case"polygons":console.warn("THREE.ColladaLoader: Unsupported primitive type: ",r.nodeName);break;case"lines":case"linestrips":case"polylist":case"triangles":t.primitives.push(ee(r));break;default:console.log(r)}}}Pe.geometries[e.getAttribute("id")]=t}),h(Ae,"library_nodes","node",ve),h(Ae,"library_visual_scenes","visual_scene",function(e){var t={name:e.getAttribute("name"),children:[]};!function(e){for(var t=e.getElementsByTagName("node"),i=0;i<t.length;i++){var s=t[i];!1===s.hasAttribute("id")&&s.setAttribute("id","three_default_"+Se++)}}(e);for(var s=i(e,"node"),o=0;o<s.length;o++)t.children.push(ve(s[o]));Pe.visualScenes[e.getAttribute("id")]=t}),h(Ae,"library_kinematics_models","kinematics_model",function(e){for(var t={name:e.getAttribute("name")||"",joints:{},links:[]},i=0;i<e.childNodes.length;i++){var s=e.childNodes[i];if(1===s.nodeType)switch(s.nodeName){case"technique_common":ae(s,t)}}Pe.kinematicsModels[e.getAttribute("id")]=t}),h(Ae,"scene","instance_kinematics_scene",function(e){for(var t={bindJointAxis:[]},i=0;i<e.childNodes.length;i++){var s=e.childNodes[i];if(1===s.nodeType)switch(s.nodeName){case"bind_joint_axis":t.bindJointAxis.push(pe(s))}}Pe.kinematicsScenes[n(e.getAttribute("url"))]=t}),console.timeEnd("THREE.ColladaLoader: Parse"),console.time("THREE.ColladaLoader: Build"),l(Pe.animations,m),l(Pe.clips,k),l(Pe.controllers,_),l(Pe.images,R),l(Pe.effects,B),l(Pe.materials,G),l(Pe.cameras,Q),l(Pe.lights,function(e){var t;switch(e.technique){case"directional":t=new o.DirectionalLight;break;case"point":t=new o.PointLight;break;case"spot":t=new o.SpotLight;break;case"ambient":t=new o.AmbientLight}return e.parameters.color&&t.color.copy(e.parameters.color),e.parameters.distance&&(t.distance=e.parameters.distance),t}),l(Pe.geometries,te),l(Pe.visualScenes,Me),console.timeEnd("THREE.ColladaLoader: Build"),function(){var e=Pe.clips;if(!0===c(e)){if(!1===c(Pe.animations)){var t=[];for(var i in Pe.animations)for(var s=f(i),r=0,a=s.length;r<a;r++)t.push(s[r]);Re.push(new o.AnimationClip("default",-1,t))}}else for(var i in e)Re.push(C(i))}(),function(){var e=Object.keys(Pe.kinematicsModels)[0],t=Object.keys(Pe.kinematicsScenes)[0],i=Object.keys(Pe.visualScenes)[0];if(void 0!==e&&void 0!==t){for(var s,a=(s=e,d(Pe.kinematicsModels[s],re)),n=function(e){return d(Pe.kinematicsScenes[e],ue)}(t),c=ke(i),h=n.bindJointAxis,l={},p=0,u=h.length;p<u;p++){var m=h[p],f=Ae.querySelector('[sid="'+m.target+'"]');if(f){var v=f.parentElement;b(m.jointIndex,v)}}var g=new o.Matrix4;De={joints:a&&a.joints,getJointValue:function(e){var t=l[e];if(t)return t.position;console.warn("THREE.ColladaLoader: Joint "+e+" doesn't exist.")},setJointValue:function(e,t){var i=l[e];if(i){var s=i.joint;if(t>s.limits.max||t<s.limits.min)console.warn("THREE.ColladaLoader: Joint "+e+" value "+t+" outside of limits (min: "+s.limits.min+", max: "+s.limits.max+").");else if(s.static)console.warn("THREE.ColladaLoader: Joint "+e+" is static.");else{var r=i.object,a=s.axis,n=i.transforms;me.identity();for(var c=0;c<n.length;c++){var h=n[c];if(h.sid&&-1!==h.sid.indexOf(e))switch(s.type){case"revolute":me.multiply(g.makeRotationAxis(a,o.Math.degToRad(t)));break;case"prismatic":me.multiply(g.makeTranslation(a.x*t,a.y*t,a.z*t));break;default:console.warn("THREE.ColladaLoader: Unknown joint type: "+s.type)}else switch(h.type){case"matrix":me.multiply(h.obj);break;case"translate":me.multiply(g.makeTranslation(h.obj.x,h.obj.y,h.obj.z));break;case"scale":me.scale(h.obj);break;case"rotate":me.multiply(g.makeRotationAxis(h.obj,h.angle))}}r.matrix.copy(me),r.matrix.decompose(r.position,r.quaternion,r.scale),l[e].position=t}}else console.log("THREE.ColladaLoader: "+e+" does not exist.")}}}function b(e,t){var i=t.getAttribute("name"),s=a.joints[e];c.traverse(function(a){a.name===i&&(l[e]={object:a,transforms:function(e){for(var t=[],i=Ae.querySelector('[id="'+e.id+'"]'),s=0;s<i.childNodes.length;s++){var a=i.childNodes[s];if(1===a.nodeType)switch(a.nodeName){case"matrix":var n=r(a.textContent),c=(new o.Matrix4).fromArray(n).transpose();t.push({sid:a.getAttribute("sid"),type:a.nodeName,obj:c});break;case"translate":case"scale":var n=r(a.textContent),h=(new o.Vector3).fromArray(n);t.push({sid:a.getAttribute("sid"),type:a.nodeName,obj:h});break;case"rotate":var n=r(a.textContent),h=(new o.Vector3).fromArray(n),l=o.Math.degToRad(n[3]);t.push({sid:a.getAttribute("sid"),type:a.nodeName,obj:h,angle:l})}}return t}(t),joint:s,position:s.zeroPosition})})}}();var je=function(e){return ke(n(i(e,"instance_visual_scene")[0].getAttribute("url")))}(i(Ae,"scene")[0]);return je.scale.multiplyScalar(Oe.unit),console.timeEnd("THREE.ColladaLoader"),{animations:Re,kinematics:De,library:Pe,scene:je}}};class I extends o.Object3D{constructor(e){super();var t=this,i=(e=e||{}).path||"/",s=e.resource,r=e.material||null;this.warnings=e.warnings,"/"!==i.substr(i.length-1)&&(i+="/");var a,n=i+s,c=n.substr(-4).toLowerCase();".dae"===c?((a=new o.ColladaLoader).log=function(e){t.warnings&&console.warn(e)},a.load(n,function(e){null!==r&&e.scene.traverse(function(e){e instanceof o.Mesh&&void 0===e.material&&(e.material=r)}),t.add(e.scene)},null,function(e){console.error(e)})):".stl"===c&&(a=new o.STLLoader).load(n,function(e){var i;e.computeFaceNormals(),i=null!==r?new o.Mesh(e,r):new o.Mesh(e,new o.MeshBasicMaterial({color:10066329})),t.add(i)},null,function(e){console.error(e)})}}class z extends o.Object3D{constructor(e){var t=(e=e||{}).material||new o.MeshBasicMaterial,i=e.vertices,s=e.colors;super(),t.side=o.DoubleSide;var r,a,n=new o.Geometry;for(r=0;r<i.length;r++)n.vertices.push(new o.Vector3(i[r].x,i[r].y,i[r].z));if(s.length===i.length){for(r=0;r<i.length;r+=3){var c=new o.Face3(r,r+1,r+2);for(a=3*r;a<3*r+3;r++){var h=new o.Color;h.setRGB(s[r].r,s[r].g,s[r].b),c.vertexColors.push(h)}n.faces.push(c)}t.vertexColors=o.VertexColors}else if(s.length===i.length/3){for(r=0;r<i.length;r+=3){var l=new o.Face3(r,r+1,r+2);l.color.setRGB(s[r/3].r,s[r/3].g,s[r/3].b),n.faces.push(l)}t.vertexColors=o.FaceColors}else for(r=0;r<i.length;r+=3){var d=new o.Face3(r,r+1,r+2);n.faces.push(d)}n.computeBoundingBox(),n.computeBoundingSphere(),n.computeFaceNormals(),this.add(new o.Mesh(n,t))}setColor(e){this.mesh.material.color.setHex(e)}}class F extends o.Object3D{constructor(e){super();var t=(e=e||{}).path||"/",i=e.message;"/"!==t.substr(t.length-1)&&(t+="/"),i.scale?this.msgScale=[i.scale.x,i.scale.y,i.scale.z]:this.msgScale=[1,1,1],this.msgColor=i.color,this.msgMesh=void 0,this.setPose(i.pose);var s=D(this.msgColor.r,this.msgColor.g,this.msgColor.b,this.msgColor.a);switch(i.type){case r:var g,b=i.scale.x,y=.23*b,w=i.scale.y,x=.5*w,T=null;if(2===i.points.length){T=new o.Vector3(i.points[0].x,i.points[0].y,i.points[0].z);var E=new o.Vector3(i.points[1].x,i.points[1].y,i.points[1].z);b=(g=T.clone().negate().add(E)).length(),w=i.scale.y,x=i.scale.x,0!==i.scale.z&&(y=i.scale.z)}this.add(new V({direction:g,origin:T,length:b,headLength:y,shaftDiameter:x,headDiameter:w,material:s}));break;case a:var M=new o.BoxGeometry(i.scale.x||1e-6,i.scale.y||1e-6,i.scale.z||1e-6);this.add(new o.Mesh(M,s));break;case n:var k=new o.SphereGeometry(.5),C=new o.Mesh(k,s);C.scale.x=i.scale.x,C.scale.y=i.scale.y,C.scale.z=i.scale.z,this.add(C);break;case c:var A=new o.CylinderGeometry(.5,.5,1,16,1,!1),N=new o.Mesh(A,s);N.quaternion.setFromAxisAngle(new o.Vector3(1,0,0),.5*Math.PI),N.scale.set(i.scale.x,i.scale.z,i.scale.y),this.add(N);break;case h:var O,_=new o.Geometry,R=new o.LineBasicMaterial({linewidth:i.scale.x});for(O=0;O<i.points.length;O++){var S=new o.Vector3;S.x=i.points[O].x,S.y=i.points[O].y,S.z=i.points[O].z,_.vertices.push(S)}if(i.colors.length===i.points.length)for(R.vertexColors=!0,O=0;O<i.points.length;O++){var P=new o.Color;P.setRGB(i.colors[O].r,i.colors[O].g,i.colors[O].b),_.colors.push(P)}else R.color.setRGB(i.color.r,i.color.g,i.color.b);this.add(new o.Line(_,R));break;case l:var j,L=new o.Geometry,F=new o.LineBasicMaterial({linewidth:i.scale.x});for(j=0;j<i.points.length;j++){var U=new o.Vector3;U.x=i.points[j].x,U.y=i.points[j].y,U.z=i.points[j].z,L.vertices.push(U)}if(i.colors.length===i.points.length)for(F.vertexColors=!0,j=0;j<i.points.length;j++){var B=new o.Color;B.setRGB(i.colors[j].r,i.colors[j].g,i.colors[j].b),L.colors.push(B)}else F.color.setRGB(i.color.r,i.color.g,i.color.b);this.add(new o.Line(L,F,o.LineSegments));break;case d:var G,q,H,W,K=new o.Object3D,Q=i.points.length,X=Q===i.colors.length,Z=Math.ceil(Q/1250);for(G=0;G<Q;G+=Z)q=new o.BoxGeometry(i.scale.x,i.scale.y,i.scale.z),H=X?D(i.colors[G].r,i.colors[G].g,i.colors[G].b,i.colors[G].a):s,(W=new o.Mesh(q,H)).position.x=i.points[G].x,W.position.y=i.points[G].y,W.position.z=i.points[G].z,K.add(W);this.add(K);break;case p:var Y,J,$,ee,te=new o.Object3D,ie=i.points.length,se=ie===i.colors.length,oe=Math.ceil(ie/1250);for(Y=0;Y<ie;Y+=oe)J=new o.SphereGeometry(.5,8,8),$=se?D(i.colors[Y].r,i.colors[Y].g,i.colors[Y].b,i.colors[Y].a):s,(ee=new o.Mesh(J,$)).scale.x=i.scale.x,ee.scale.y=i.scale.y,ee.scale.z=i.scale.z,ee.position.x=i.points[Y].x,ee.position.y=i.points[Y].y,ee.position.z=i.points[Y].z,te.add(ee);this.add(te);break;case u:var re,ae=new o.Geometry,ne=new o.ParticleBasicMaterial({size:i.scale.x});for(re=0;re<i.points.length;re++){var ce=new o.Vector3;ce.x=i.points[re].x,ce.y=i.points[re].y,ce.z=i.points[re].z,ae.vertices.push(ce)}if(i.colors.length===i.points.length)for(ne.vertexColors=!0,re=0;re<i.points.length;re++){var he=new o.Color;he.setRGB(i.colors[re].r,i.colors[re].g,i.colors[re].b),ae.colors.push(he)}else ne.color.setRGB(i.color.r,i.color.g,i.color.b);this.add(new o.ParticleSystem(ae,ne));break;case m:if(i.text.length>0){var le=this.msgColor,de=document.createElement("canvas"),pe=de.getContext("2d");pe.font="normal 100px sans-serif";var ue=pe.measureText(i.text).width;de.width=ue,de.height=150,pe.font="normal 100px sans-serif",pe.fillStyle="rgba("+Math.round(255*le.r)+", "+Math.round(255*le.g)+", "+Math.round(255*le.b)+", "+le.a+")",pe.textAlign="left",pe.textBaseline="middle",pe.fillText(i.text,0,de.height/2);var me=new o.Texture(de);me.needsUpdate=!0;var fe=new o.SpriteMaterial({map:me,useScreenCoordinates:!1}),ve=new o.Sprite(fe),ge=i.scale.x;ve.scale.set(ue/de.height*ge,ge,1),this.add(ve)}break;case f:var be=null;0===i.color.r&&0===i.color.g&&0===i.color.b&&0===i.color.a||(be=s),this.msgMesh=i.mesh_resource.substr(10);var ye=new I({path:t,resource:this.msgMesh,material:be});this.add(ye);break;case v:var we=new z({material:s,vertices:i.points,colors:i.colors});we.scale.set(i.scale.x,i.scale.y,i.scale.z),this.add(we);break;default:console.error("Currently unsupported marker type: "+i.type)}}setPose(e){this.position.x=e.position.x,this.position.y=e.position.y,this.position.z=e.position.z,this.quaternion.set(e.orientation.x,e.orientation.y,e.orientation.z,e.orientation.w),this.quaternion.normalize(),this.updateMatrixWorld()}update(e){if(this.setPose(e.pose),e.color.r!==this.msgColor.r||e.color.g!==this.msgColor.g||e.color.b!==this.msgColor.b||e.color.a!==this.msgColor.a){var t=D(e.color.r,e.color.g,e.color.b,e.color.a);switch(e.type){case h:case l:case u:break;case r:case a:case n:case c:case v:case m:this.traverse(function(e){e instanceof o.Mesh&&(e.material=t)});break;case f:var i=null;0===e.color.r&&0===e.color.g&&0===e.color.b&&0===e.color.a||(i=this.colorMaterial),this.traverse(function(e){e instanceof o.Mesh&&(e.material=i)});break;case d:case p:default:return!1}this.msgColor=e.color}var s=Math.abs(this.msgScale[0]-e.scale.x)>1e-6||Math.abs(this.msgScale[1]-e.scale.y)>1e-6||Math.abs(this.msgScale[2]-e.scale.z)>1e-6;switch(this.msgScale=[e.scale.x,e.scale.y,e.scale.z],e.type){case a:case n:case c:if(s)return!1;break;case m:if(s||this.text!==e.text)return!1;break;case f:if(e.mesh_resource.substr(10)!==this.msgMesh)return!1;if(s)return!1;break;case r:case h:case l:case d:case p:case u:case v:return!1}return!0}dispose(){this.children.forEach(function(e){e instanceof I?e.children.forEach(function(t){void 0!==t.material&&t.material.dispose(),t.children.forEach(function(e){void 0!==e.geometry&&e.geometry.dispose(),void 0!==e.material&&e.material.dispose(),t.remove(e)}),e.remove(t)}):(void 0!==e.geometry&&e.geometry.dispose(),void 0!==e.material&&e.material.dispose()),e.parent.remove(e)})}}class U extends o.Object3D{constructor(e){super();var t=this;e=e||{},this.parent=e.parent;var s=e.handle,r=e.message;this.message=r,this.name=r.name,this.camera=e.camera,this.path=e.path||"/",this.loader=e.loader,this.dragging=!1,this.startMousePos=new o.Vector2,this.isShift=!1;var a=new o.Quaternion(r.orientation.x,r.orientation.y,r.orientation.z,r.orientation.w);a.normalize();var n=new o.Vector3(1,0,0);switch(n.applyQuaternion(a),this.currentControlOri=new o.Quaternion,r.interaction_mode){case N:case A:this.addEventListener("mousemove",this.parent.move3d.bind(this.parent,this,n));case M:this.addEventListener("mousemove",this.parent.moveAxis.bind(this.parent,this,n)),this.addEventListener("touchmove",this.parent.moveAxis.bind(this.parent,this,n));break;case C:this.addEventListener("mousemove",this.parent.rotateAxis.bind(this.parent,this,a));break;case k:this.addEventListener("mousemove",this.parent.movePlane.bind(this.parent,this,n));break;case E:this.addEventListener("click",this.parent.buttonClick.bind(this.parent,this))}function c(e){e.stopPropagation()}r.interaction_mode!==T&&(this.addEventListener("mousedown",this.parent.startDrag.bind(this.parent,this)),this.addEventListener("mouseup",this.parent.stopDrag.bind(this.parent,this)),this.addEventListener("contextmenu",this.parent.showMenu.bind(this.parent,this)),this.addEventListener("mouseup",function(e){0===t.startMousePos.distanceToSquared(e.mousePos)&&(e.type="contextmenu",t.dispatchEvent(e))}),this.addEventListener("mouseover",c),this.addEventListener("mouseout",c),this.addEventListener("click",c),this.addEventListener("mousedown",function(e){t.startMousePos=e.mousePos}),this.addEventListener("touchstart",function(e){1===e.domEvent.touches.length&&(e.type="mousedown",e.domEvent.button=0,t.dispatchEvent(e))}),this.addEventListener("touchmove",function(e){1===e.domEvent.touches.length&&(e.type="mousemove",e.domEvent.button=0,t.dispatchEvent(e))}),this.addEventListener("touchend",function(e){0===e.domEvent.touches.length&&(e.domEvent.button=0,e.type="mouseup",t.dispatchEvent(e),e.type="click",t.dispatchEvent(e))}),window.addEventListener("keydown",function(e){16===e.keyCode&&(t.isShift=!0)}),window.addEventListener("keyup",function(e){16===e.keyCode&&(t.isShift=!1)}));var h=new o.Quaternion,l=this.parent.position.clone().multiplyScalar(-1);switch(r.orientation_mode){case O:h=this.parent.quaternion.clone().inverse();break;case _:case R:break;default:console.error("Unkown orientation mode: "+r.orientation_mode)}var d=new i.TFClient({ros:s.tfClient.ros,fixedFrame:s.message.header.frame_id,serverName:s.tfClient.serverName});r.markers.forEach(function(e){var s=function(s){var r=new F({message:e,path:t.path,loader:t.loader});if(null!==s){var a=new i.Pose({position:r.position,orientation:r.quaternion});a.applyTransform(new i.Transform(s));var n=new F({message:e,path:t.path,loader:t.loader});n.position.add(l),n.position.applyQuaternion(h),n.quaternion.multiplyQuaternions(h,n.quaternion);var c=new o.Vector3(n.position.x,n.position.y,n.position.z),p=new i.Transform({translation:c,orientation:n.quaternion});a.applyTransform(p),r.setPose(a),r.updateMatrixWorld(),d.unsubscribe(e.header.frame_id)}t.add(r)};""!==e.header.frame_id?d.subscribe(e.header.frame_id,s):s(null)})}updateMatrixWorld(e){var t=this.message;switch(t.orientation_mode){case O:super.updateMatrixWorld(e),this.currentControlOri.copy(this.quaternion),this.currentControlOri.normalize();break;case _:this.quaternion.copy(this.parent.quaternion.clone().inverse()),this.updateMatrix(),this.matrixWorldNeedsUpdate=!0,super.updateMatrixWorld(e),this.currentControlOri.copy(this.quaternion);break;case R:this.camera.updateMatrixWorld();var i=(new o.Matrix4).extractRotation(this.camera.matrixWorld),s=new o.Matrix4,r=.5*Math.PI,a=new o.Euler(-r,0,r);s.makeRotationFromEuler(a);var n=new o.Matrix4;n.getInverse(this.parent.matrixWorld),i.multiplyMatrices(i,s),i.multiplyMatrices(n,i),this.currentControlOri.setFromRotationMatrix(i),t.independent_marker_orientation||(this.quaternion.copy(this.currentControlOri),this.updateMatrix(),this.matrixWorldNeedsUpdate=!0),super.updateMatrixWorld(e);break;default:console.error("Unkown orientation mode: "+t.orientation_mode)}}}class B extends o.EventDispatcher{constructor(e){super();var t,i,s,o=this,r=(e=e||{}).menuEntries,a=e.className||"default-interactive-marker-menu",n=(e.entryClassName,e.overlayClassName||"default-interactive-marker-overlay"),c=e.menuFontSize||"0.8em",h=[];if(h[0]={children:[]},null===document.getElementById("default-interactive-marker-menu-css")){var l=document.createElement("style");l.id="default-interactive-marker-menu-css",l.type="text/css",l.innerHTML=".default-interactive-marker-menu {background-color: #444444;border: 1px solid #888888;border: 1px solid #888888;padding: 0px 0px 0px 0px;color: #FFFFFF;font-family: sans-serif;font-size: "+c+";z-index: 1002;}.default-interactive-marker-menu ul {padding: 0px 0px 5px 0px;margin: 0px;list-style-type: none;}.default-interactive-marker-menu ul li div {-webkit-touch-callout: none;-webkit-user-select: none;-khtml-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;cursor: default;padding: 3px 10px 3px 10px;}.default-interactive-marker-menu-entry:hover {  background-color: #666666;  cursor: pointer;}.default-interactive-marker-menu ul ul {  font-style: italic;  padding-left: 10px;}.default-interactive-marker-overlay {  position: absolute;  top: 0%;  left: 0%;  width: 100%;  height: 100%;  background-color: black;  z-index: 1001;  -moz-opacity: 0.0;  opacity: .0;  filter: alpha(opacity = 0);}",document.getElementsByTagName("head")[0].appendChild(l)}for(this.menuDomElem=document.createElement("div"),this.menuDomElem.style.position="absolute",this.menuDomElem.className=a,this.menuDomElem.addEventListener("contextmenu",function(e){e.preventDefault()}),this.overlayDomElem=document.createElement("div"),this.overlayDomElem.className=n,this.hideListener=this.hide.bind(this),this.overlayDomElem.addEventListener("contextmenu",this.hideListener),this.overlayDomElem.addEventListener("click",this.hideListener),this.overlayDomElem.addEventListener("touchstart",this.hideListener),t=0;t<r.length;t++)h[s=(i=r[t]).id]={title:i.title,id:s,children:[]};for(t=0;t<r.length;t++){var d=h[s=(i=r[t]).id];h[i.parent_id].children.push(d)}function p(e,t){this.dispatchEvent({type:"menu-select",domEvent:t,id:e.id,controlName:this.controlName}),this.hide(t)}!function e(t,i){var s=document.createElement("ul");t.appendChild(s);for(var r=i.children,a=0;a<r.length;a++){var n=document.createElement("li"),c=document.createElement("div");c.appendChild(document.createTextNode(r[a].title)),s.appendChild(n),n.appendChild(c),r[a].children.length>0?(e(n,r[a]),c.addEventListener("click",o.hide.bind(o)),c.addEventListener("touchstart",o.hide.bind(o))):(c.addEventListener("click",p.bind(o,r[a])),c.addEventListener("touchstart",p.bind(o,r[a])),c.className="default-interactive-marker-menu-entry")}}(this.menuDomElem,h[0])}show(e,t){t&&t.preventDefault&&t.preventDefault(),this.controlName=e.name,void 0!==t.domEvent.changedTouches?(this.menuDomElem.style.left=t.domEvent.changedTouches[0].pageX+"px",this.menuDomElem.style.top=t.domEvent.changedTouches[0].pageY+"px"):(this.menuDomElem.style.left=t.domEvent.clientX+"px",this.menuDomElem.style.top=t.domEvent.clientY+"px"),document.body.appendChild(this.overlayDomElem),document.body.appendChild(this.menuDomElem)}hide(e){e&&e.preventDefault&&e.preventDefault(),document.body.removeChild(this.overlayDomElem),document.body.removeChild(this.menuDomElem)}}class G extends o.Object3D{constructor(e){super();var t=this,i=(e=e||{}).handle;this.name=i.name;var s=e.camera,r=e.path||"/",a=e.loader;this.dragging=!1,this.onServerSetPose({pose:i.pose}),this.dragStart={position:new o.Vector3,orientation:new o.Quaternion,positionWorld:new o.Vector3,orientationWorld:new o.Quaternion,event3d:{}},i.controls.forEach(function(e){t.add(new U({parent:t,handle:i,message:e,camera:s,path:r,loader:a}))}),i.menuEntries.length>0&&(this.menu=new B({menuEntries:i.menuEntries,menuFontSize:i.menuFontSize}),this.menu.addEventListener("menu-select",function(e){t.dispatchEvent(e)}))}showMenu(e,t){this.menu&&this.menu.show(e,t)}moveAxis(e,t,i){if(this.dragging){var s=e.currentControlOri,r=t.clone().applyQuaternion(s),a=this.dragStart.event3d.intersection.point,n=r.clone().applyQuaternion(this.dragStart.orientationWorld.clone()),c=new o.Ray(a,n),h=j(c,i.camera,i.mousePos),l=new o.Vector3;l.addVectors(this.dragStart.position,r.clone().applyQuaternion(this.dragStart.orientation).multiplyScalar(h)),this.setPosition(e,l),i.stopPropagation()}}move3d(e,t,i){if(this.dragging)if(e.isShift);else{var s=e.camera.getWorldDirection(),r=Math.abs(s.x),a=Math.abs(s.y),n=Math.abs(s.z),c=new o.Quaternion(1,0,0,1);a>r&&a>n?c=new o.Quaternion(0,0,1,1):n>r&&n>a&&(c=new o.Quaternion(0,1,0,1)),c.normalize(),(t=new o.Vector3(1,0,0)).applyQuaternion(c),this.movePlane(e,t,i)}}movePlane(e,t,i){if(this.dragging){var s=e.currentControlOri,r=t.clone().applyQuaternion(s),a=this.dragStart.event3d.intersection.point,n=r.clone().applyQuaternion(this.dragStart.orientationWorld),c=S(i.mouseRay,a,n),h=new o.Vector3;h.subVectors(c,a),h.add(this.dragStart.positionWorld),this.setPosition(e,h),i.stopPropagation()}}rotateAxis(e,t,i){if(this.dragging){e.updateMatrixWorld();var s=e.currentControlOri.clone().multiply(t.clone()),r=new o.Vector3(1,0,0).applyQuaternion(s),a=this.dragStart.event3d.intersection.point,n=r.applyQuaternion(this.dragStart.orientationWorld),c=S(i.mouseRay,a,n),h=new o.Ray(this.dragStart.positionWorld,n),l=S(h,a,n),d=this.dragStart.orientationWorld.clone().multiply(s).clone().inverse();c.sub(l),c.applyQuaternion(d);var p=this.dragStart.event3d.intersection.point.clone();p.sub(l),p.applyQuaternion(d);var u=Math.atan2(c.y,c.z),m=Math.atan2(p.y,p.z)-u,f=new o.Quaternion;f.setFromAxisAngle(r,m),this.setOrientation(e,f.multiply(this.dragStart.orientationWorld)),i.stopPropagation()}}feedbackEvent(e,t){this.dispatchEvent({type:e,position:this.position.clone(),orientation:this.quaternion.clone(),controlName:t.name})}startDrag(e,t){if(0===t.domEvent.button){t.stopPropagation(),this.dragging=!0,this.updateMatrixWorld(!0);var i=new o.Vector3;this.matrixWorld.decompose(this.dragStart.positionWorld,this.dragStart.orientationWorld,i),this.dragStart.position=this.position.clone(),this.dragStart.orientation=this.quaternion.clone(),this.dragStart.event3d=t,this.feedbackEvent("user-mousedown",e)}}stopDrag(e,t){0===t.domEvent.button&&(t.stopPropagation(),this.dragging=!1,this.dragStart.event3d={},this.onServerSetPose(this.bufferedPoseEvent),this.bufferedPoseEvent=void 0,this.feedbackEvent("user-mouseup",e))}buttonClick(e,t){t.stopPropagation(),this.feedbackEvent("user-button-click",e)}setPosition(e,t){this.position.copy(t),this.feedbackEvent("user-pose-change",e)}setOrientation(e,t){t.normalize(),this.quaternion.copy(t),this.feedbackEvent("user-pose-change",e)}onServerSetPose(e){if(void 0!==e)if(this.dragging)this.bufferedPoseEvent=e;else{var t=e.pose;this.position.copy(t.position),this.quaternion.copy(t.orientation),this.updateMatrixWorld(!0)}}dispose(){var e=this;this.children.forEach(function(t){t.children.forEach(function(e){e.dispose(),t.remove(e)}),e.remove(t)})}}class q extends s{constructor(e){super(),e=e||{},this.message=e.message,this.feedbackTopic=e.feedbackTopic,this.tfClient=e.tfClient,this.menuFontSize=e.menuFontSize||"0.8em",this.name=this.message.name,this.header=this.message.header,this.controls=this.message.controls,this.menuEntries=this.message.menu_entries,this.dragging=!1,this.timeoutHandle=null,this.tfTransform=new i.Transform,this.pose=new i.Pose,this.setPoseFromClientBound=this.setPoseFromClient.bind(this),this.onMouseDownBound=this.onMouseDown.bind(this),this.onMouseUpBound=this.onMouseUp.bind(this),this.onButtonClickBound=this.onButtonClick.bind(this),this.onMenuSelectBound=this.onMenuSelect.bind(this),this.setPoseFromServer(this.message.pose),this.tfUpdateBound=this.tfUpdate.bind(this)}subscribeTf(){0===this.message.header.stamp.secs&&0===this.message.header.stamp.nsecs&&this.tfClient.subscribe(this.message.header.frame_id,this.tfUpdateBound)}unsubscribeTf(){this.tfClient.unsubscribe(this.message.header.frame_id,this.tfUpdateBound)}emitServerPoseUpdate(){var e=new i.Pose(this.pose);e.applyTransform(this.tfTransform),this.emit("pose",e)}setPoseFromServer(e){this.pose=new i.Pose(e),this.emitServerPoseUpdate()}tfUpdate(e){this.tfTransform=new i.Transform(e),this.emitServerPoseUpdate()}setPoseFromClient(e){this.pose=new i.Pose(e);var t=this.tfTransform.clone();t.rotation.invert(),t.translation.multiplyQuaternion(t.rotation),t.translation.x*=-1,t.translation.y*=-1,t.translation.z*=-1,this.pose.applyTransform(t),this.sendFeedback(g,void 0,0,e.controlName),this.dragging&&(this.timeoutHandle&&clearTimeout(this.timeoutHandle),this.timeoutHandle=setTimeout(this.setPoseFromClient.bind(this,e),250))}onButtonClick(e){this.sendFeedback(y,e.clickPosition,0,e.controlName)}onMouseDown(e){this.sendFeedback(w,e.clickPosition,0,e.controlName),this.dragging=!0}onMouseUp(e){this.sendFeedback(x,e.clickPosition,0,e.controlName),this.dragging=!1,this.timeoutHandle&&clearTimeout(this.timeoutHandle)}onMenuSelect(e){this.sendFeedback(b,void 0,e.id,e.controlName)}sendFeedback(e,t,i,s){var o=void 0!==t;t=t||{x:0,y:0,z:0};var r={header:this.header,client_id:this.clientID,marker_name:this.name,control_name:s,event_type:e,pose:this.pose,mouse_point:t,mouse_point_valid:o,menu_entry_id:i};this.feedbackTopic.publish(r)}}class H extends o.Object3D{constructor(e){super(),e=e||{};var t=this;this.tfClient=e.tfClient,this.frameID=e.frameID;var s=e.object;this.pose=e.pose||new i.Pose,this.visible=!1,s&&this.add(s),this.updatePose(this.pose),this.tfUpdate=function(e){t.transformPose(e)},this.tfClient&&this.tfClient.subscribe(this.frameID,this.tfUpdate)}updatePose(e){this.position.set(e.position.x,e.position.y,e.position.z),this.quaternion.set(e.orientation.x,e.orientation.y,e.orientation.z,e.orientation.w),this.updateMatrixWorld(!0)}unsubscribeTf(){this.tfClient.unsubscribe(this.frameID,this.tfUpdate)}transformPose(e){var t=new i.Transform(e),s=new i.Pose(this.pose);s.applyTransform(t),this.updatePose(s),this.visible=!0}}class W extends o.Object3D{constructor(e){super();var t=this,i=(e=e||{}).shaftRadius||.008,s=e.headRadius||.023,r=e.headLength||.1,a=e.scale||1,n=e.lineType||"full",c=e.lineDashLength||.1;function h(e){var s=new o.Color;s.setRGB(e.x,e.y,e.z);var r=new o.MeshBasicMaterial({color:s.getHex()});t.disposables.push(r);var a=new o.Vector3;a.crossVectors(e,new o.Vector3(0,-1,0));var h=new o.Quaternion;h.setFromAxisAngle(a,.5*Math.PI);var l,d=new o.Mesh(t.headGeom,r);if(d.position.copy(e),d.position.multiplyScalar(.95),d.quaternion.copy(h),d.updateMatrix(),t.add(d),"dashed"===n)for(var p=c,u=0;p/2+3*p*u+p/2<=1;++u){var m=new o.CylinderGeometry(i,i,p);t.disposables.push(m),(l=new o.Mesh(m,r)).position.copy(e),l.position.multiplyScalar(p/2+3*p*u),l.quaternion.copy(h),l.updateMatrix(),t.add(l)}else"full"===n?((l=new o.Mesh(t.lineGeom,r)).position.copy(e),l.position.multiplyScalar(.45),l.quaternion.copy(h),l.updateMatrix(),t.add(l)):console.warn("[Axes]: Unsupported line type. Not drawing any axes.")}t.disposables=[],this.scale.set(a,a,a),this.lineGeom=new o.CylinderGeometry(i,i,1-r),this.headGeom=new o.CylinderGeometry(0,s,r),t.disposables.push(this.lineGeom),t.disposables.push(this.headGeom),h(new o.Vector3(1,0,0)),h(new o.Vector3(0,1,0)),h(new o.Vector3(0,0,1))}dispose(e){this.disposables.map(e=>{e.dispose&&e.dispose()})}}class K extends o.Mesh{constructor(e){for(var t=(e=e||{}).message,i=e.color||{r:255,g:255,b:255},s=e.opacity||1,r=t.info.width,a=t.info.height,n=new o.PlaneBufferGeometry(r,a),c=new Uint8Array(r*a*3),h=0;h<a;h++)for(var l=0;l<r;l++){var d,p=l+(a-h-1)*r,u=t.data[p];d=100===u?0:0===u?255:127;var m=3*(l+h*r);c[m]=d*i.r/255,c[++m]=d*i.g/255,c[++m]=d*i.b/255}var f=new o.DataTexture(c,r,a,o.RGBFormat);f.flipY=!0,f.minFilter=o.LinearFilter,f.magFilter=o.LinearFilter,f.needsUpdate=!0;var v=new o.MeshBasicMaterial({map:f,transparent:s<1,opacity:s});v.side=o.DoubleSide,super(n,v),this.quaternion.copy(new o.Quaternion(t.info.origin.orientation.x,t.info.origin.orientation.y,t.info.origin.orientation.z,t.info.origin.orientation.w)),this.position.x=r*t.info.resolution/2+t.info.origin.position.x,this.position.y=a*t.info.resolution/2+t.info.origin.position.y,this.position.z=t.info.origin.position.z,this.scale.x=t.info.resolution,this.scale.y=t.info.resolution}}class Q extends o.Object3D{constructor(e){super(),e=e||{},this.tfClient=e.tfClient,this.rootObject=e.rootObject||new o.Object3D,this.max_pts=e.max_pts||1e4,this.pointRatio=e.pointRatio||1,this.messageRatio=e.messageRatio||1,this.messageCount=0,this.material=e.material||{},this.colorsrc=e.colorsrc,this.colormap=e.colormap,("color"in e||"size"in e||"texture"in e)&&console.warn('toplevel "color", "size" and "texture" options are deprecated.They should beprovided within a "material" option, e.g. :  { tfClient, material : { color: mycolor, size: mysize, map: mytexture }, ... }'),this.sn=null}setup(e,t,i){if(null===this.sn&&!this.destroyed){i=i||[],this.fields={};for(var s=0;s<i.length;s++)this.fields[i[s].name]=i[s];if(this.geom=new o.BufferGeometry,this.positions=new o.BufferAttribute(new Float32Array(3*this.max_pts),3,!1),this.geom.addAttribute("position",this.positions.setDynamic(!0)),!this.colorsrc&&this.fields.rgb&&(this.colorsrc="rgb"),this.colorsrc){var r=this.fields[this.colorsrc];if(r){this.colors=new o.BufferAttribute(new Float32Array(3*this.max_pts),3,!1),this.geom.addAttribute("color",this.colors.setDynamic(!0));var a=r.offset;this.getColor=[function(e,t,i){return e.getInt8(t+a,i)},function(e,t,i){return e.getUint8(t+a,i)},function(e,t,i){return e.getInt16(t+a,i)},function(e,t,i){return e.getUint16(t+a,i)},function(e,t,i){return e.getInt32(t+a,i)},function(e,t,i){return e.getUint32(t+a,i)},function(e,t,i){return e.getFloat32(t+a,i)},function(e,t,i){return e.getFloat64(t+a,i)}][r.datatype-1],this.colormap=this.colormap||function(e){return new o.Color(e)}}else console.warn('unavailable field "'+this.colorsrc+'" for coloring.')}this.material.isMaterial||(this.colors&&void 0===this.material.vertexColors&&(this.material.vertexColors=o.VertexColors),this.material=new o.PointsMaterial(this.material)),this.object=new o.Points(this.geom,this.material),this.sn=new H({frameID:e,tfClient:this.tfClient,object:this.object}),this.rootObject.add(this.sn)}return this.messageCount++%this.messageRatio==0}update(e){this.geom.setDrawRange(0,e),this.positions.needsUpdate=!0,this.positions.updateRange.count=e*this.positions.itemSize,this.colors&&(this.colors.needsUpdate=!0,this.colors.updateRange.count=e*this.colors.itemSize)}dispose(e){this.destroyed=!0,this.positions&&(this.positions.array=null),this.positions=null,this.colors&&(this.colors.array=null),this.colors=null,this.rootObject.remove(this.sn)}}function X(e,t,i,s){var o,r=0,a=0,n=0,c=e.length,h=t.length;i=i||h;var l=((s=s||1)-1)*i*8;for(o=0;o<c&&n<h;o++)r=(r<<6)+X.e[e.charAt(o)],(a+=6)>=8&&(a-=8,t[n++]=r>>>a&255,n%i==0&&(o+=Math.ceil((l-a)/6),(a%=8)>0&&(r=X.e[e.charAt(o)])));return Math.floor(n/i)}X.S="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",X.e={};for(var Z=0;Z<64;Z++)X.e[X.S.charAt(Z)]=Z;class Y extends o.Object3D{constructor(e){var t=(e=e||{}).urdfModel,s=e.path||"/",r=e.tfClient,a=e.tfPrefix||"",n=e.loader;super();var c=t.links;for(var h in c)for(var l=c[h],d=0;d<l.visuals.length;d++){var p=l.visuals[d];if(p&&p.geometry){var u=a+"/"+l.name,m=null;if(p.material&&p.material.color){var f=p.material&&p.material.color;m=D(f.r,f.g,f.b,f.a)}if(p.geometry.type===i.URDF_MESH){var v=p.geometry.filename,g=v.indexOf("package://");-1!==g&&(v=v.substr(g+"package://".length));var b=v.substr(-4).toLowerCase();if(".dae"===b||".stl"===b){var y=new I({path:s,resource:v,loader:n,material:m});l.visuals[d].geometry.scale&&y.scale.copy(p.geometry.scale);var w=new H({frameID:u,pose:p.origin,tfClient:r,object:y});this.add(w)}else console.warn("Could not load geometry mesh: "+v)}else{var x;switch(m||(m=D(0,0,0,1)),p.geometry.type){case i.URDF_BOX:var T=p.geometry.dimension,E=new o.BoxGeometry(T.x,T.y,T.z);x=new o.Mesh(E,m);break;case i.URDF_CYLINDER:var M=p.geometry.radius,k=p.geometry.length,C=new o.CylinderGeometry(M,M,k,16,1,!1);(x=new o.Mesh(C,m)).quaternion.setFromAxisAngle(new o.Vector3(1,0,0),.5*Math.PI);break;case i.URDF_SPHERE:var A=new o.SphereGeometry(p.geometry.radius,16);x=new o.Mesh(A,m)}var N=new H({frameID:u,pose:p.origin,tfClient:r,object:x});this.add(N)}}}}unsubscribeTf(){this.children.forEach(function(e){"function"==typeof e.unsubscribeTf&&e.unsubscribeTf()})}}class J{constructor(e){e=e||{},this.mouseHandler=e.mouseHandler,this.hoverObjs={},this.mouseHandler.addEventListener("mouseover",this.onMouseOver.bind(this)),this.mouseHandler.addEventListener("mouseout",this.onMouseOut.bind(this))}onMouseOver(e){this.hoverObjs[e.currentTarget.uuid]=e.currentTarget}onMouseOut(e){var t=e.currentTarget.uuid;t in this.hoverObjs&&delete this.hoverObjs[t]}renderHighlights(e,t,i){this.makeEverythingInvisible(e),this.makeHighlightedVisible(e);var s=e.overrideMaterial;e.overrideMaterial=new o.MeshBasicMaterial({fog:!1,opacity:.5,transparent:!0,depthTest:!0,depthWrite:!1,polygonOffset:!0,polygonOffsetUnits:-1,side:o.DoubleSide}),t.render(e,i),e.overrideMaterial=s,this.restoreVisibility(e)}makeEverythingInvisible(e){e.traverse(function(e){(e instanceof o.Mesh||e instanceof o.Line||e instanceof o.Sprite)&&(e.previousVisibility=e.visible,e.visible=!1)})}makeHighlightedVisible(e){var t=function(e){(e instanceof o.Mesh||e instanceof o.Line||e instanceof o.Sprite)&&(e.visible=!0)};for(var i in this.hoverObjs){var s=this.hoverObjs[i];s.visible=!0,s.traverse(t)}}restoreVisibility(e){e.traverse(function(e){e.hasOwnProperty("previousVisibility")&&(e.visible=e.previousVisibility)}.bind(this))}}class $ extends o.EventDispatcher{constructor(e){super(),this.renderer=e.renderer,this.camera=e.camera,this.rootObject=e.rootObject,this.fallbackTarget=e.fallbackTarget,this.lastTarget=this.fallbackTarget,this.dragging=!1;this.listeners={},["contextmenu","click","dblclick","mouseout","mousedown","mouseup","mousemove","mousewheel","DOMMouseScroll","touchstart","touchend","touchcancel","touchleave","touchmove"].forEach(function(e){this.listeners[e]=this.processDomEvent.bind(this),this.renderer.domElement.addEventListener(e,this.listeners[e],!1)},this)}processDomEvent(e){e.preventDefault();var t,i,s=e.target,r=s.getBoundingClientRect();if(-1!==e.type.indexOf("touch")){t=0,i=0;for(var a=0;a<e.touches.length;++a)t+=e.touches[a].clientX,i+=e.touches[a].clientY;t/=e.touches.length,i/=e.touches.length}else t=e.clientX,i=e.clientY;var n=t-r.left-s.clientLeft+s.scrollLeft,c=i-r.top-s.clientTop+s.scrollTop,h=n/s.clientWidth*2-1,l=-c/s.clientHeight*2+1,d=new o.Vector3(h,l,.5);d.unproject(this.camera);var p=new o.Raycaster(this.camera.position.clone(),d.sub(this.camera.position).normalize());p.linePrecision=.001;var u=p.ray,m={mousePos:new o.Vector2(h,l),mouseRay:u,domEvent:e,camera:this.camera,intersection:this.lastIntersection};if("mouseout"===e.type)return this.dragging&&(this.notify(this.lastTarget,"mouseup",m),this.dragging=!1),this.notify(this.lastTarget,"mouseout",m),void(this.lastTarget=null);if("touchleave"===e.type||"touchend"===e.type)return this.dragging&&(this.notify(this.lastTarget,"mouseup",m),this.dragging=!1),this.notify(this.lastTarget,"touchend",m),void(this.lastTarget=null);if(this.dragging)return this.notify(this.lastTarget,e.type,m),void(("mouseup"===e.type&&2===e.button||"click"===e.type||"touchend"===e.type)&&(this.dragging=!1));s=this.lastTarget;var f;if((f=p.intersectObject(this.rootObject,!0)).length>0?(s=f[0].object,m.intersection=this.lastIntersection=f[0]):s=this.fallbackTarget,s!==this.lastTarget&&e.type.match(/mouse/)){var v=this.notify(s,"mouseover",m);0===v?this.notify(this.lastTarget,"mouseout",m):1===v&&(s=this.fallbackTarget)!==this.lastTarget&&(this.notify(s,"mouseover",m),this.notify(this.lastTarget,"mouseout",m))}s!==this.lastTarget&&e.type.match(/touch/)&&(this.notify(s,e.type,m)?(this.notify(this.lastTarget,"touchleave",m),this.notify(this.lastTarget,"touchend",m)):(s=this.fallbackTarget)!==this.lastTarget&&(this.notify(this.lastTarget,"touchmove",m),this.notify(this.lastTarget,"touchend",m)));this.notify(s,e.type,m),"mousedown"!==e.type&&"touchstart"!==e.type&&"touchmove"!==e.type||(this.dragging=!0),this.lastTarget=s}notify(e,t,i){for(i.type=t,i.cancelBubble=!1,i.continueBubble=!1,i.stopPropagation=function(){i.cancelBubble=!0},i.continuePropagation=function(){i.continueBubble=!0},i.currentTarget=e;i.currentTarget;){if(i.currentTarget.dispatchEvent&&i.currentTarget.dispatchEvent instanceof Function){if(i.currentTarget.dispatchEvent(i),i.cancelBubble)return this.dispatchEvent(i),0;if(i.continueBubble)return 2}i.currentTarget=i.currentTarget.parent}return 1}}class ee extends o.EventDispatcher{constructor(e){super();var t=this,i=(e=e||{}).scene;this.camera=e.camera,this.center=new o.Vector3,this.userZoom=!0,this.userZoomSpeed=e.userZoomSpeed||1,this.userRotate=!0,this.userRotateSpeed=e.userRotateSpeed||1,this.autoRotate=e.autoRotate,this.autoRotateSpeed=e.autoRotateSpeed||2,this.displayPanAndZoomFrame=void 0===e.displayPanAndZoomFrame||!!e.displayPanAndZoomFrame,this.lineTypePanAndZoomFrame=e.dashedPanAndZoomFrame||"full",this.camera.up=new o.Vector3(0,0,1);var s=1800,r=10,a=new o.Vector2,n=new o.Vector2,c=new o.Vector2,h=new o.Vector2,l=new o.Vector2,d=new o.Vector2,p=new o.Vector3,u=new o.Vector3,m=new o.Vector3,f=new o.Vector3,v=new Array(2),g=new Array(2);this.phiDelta=0,this.thetaDelta=0,this.scale=1,this.lastPosition=new o.Vector3;var b={NONE:-1,ROTATE:0,ZOOM:1,MOVE:2},y=b.NONE;function w(e,t,i){var s=new o.Vector3;new o.Vector3;s.subVectors(t,e.origin);var r=e.direction.dot(i);if(Math.abs(r)<e.precision)return null;var a=i.dot(s)/r;return e.direction.clone().multiplyScalar(a)}function x(e){if(t.userZoom){var i=e.domEvent;(void 0!==i.wheelDelta?i.wheelDelta:-i.detail)>0?t.zoomIn():t.zoomOut(),this.showAxes()}}this.axes=new W({shaftRadius:.025,headRadius:.07,headLength:.2,lineType:this.lineTypePanAndZoomFrame}),this.displayPanAndZoomFrame&&(i.add(this.axes),this.axes.traverse(function(e){e.visible=!1})),this.addEventListener("mousedown",function(e){var i=e.domEvent;switch(i.preventDefault(),i.button){case 0:y=b.ROTATE,a.set(i.clientX,i.clientY);break;case 1:y=b.MOVE,u=new o.Vector3(0,0,1);var s=(new o.Matrix4).extractRotation(this.camera.matrix);u.applyMatrix4(s),p=t.center.clone(),m=t.camera.position.clone(),f=w(e.mouseRay,p,u);break;case 2:y=b.ZOOM,h.set(i.clientX,i.clientY)}this.showAxes()}),this.addEventListener("mouseup",function(e){t.userRotate&&(y=b.NONE)}),this.addEventListener("mousemove",function(e){var i=e.domEvent;if(y===b.ROTATE)n.set(i.clientX,i.clientY),c.subVectors(n,a),t.rotateLeft(2*Math.PI*c.x/s*t.userRotateSpeed),t.rotateUp(2*Math.PI*c.y/s*t.userRotateSpeed),a.copy(n),this.showAxes();else if(y===b.ZOOM)l.set(i.clientX,i.clientY),d.subVectors(l,h),d.y>0?t.zoomIn():t.zoomOut(),h.copy(l),this.showAxes();else if(y===b.MOVE){var r=w(e.mouseRay,t.center,u);if(!r)return;var v=(new o.Vector3).subVectors(f.clone(),r.clone());t.center.addVectors(p.clone(),v.clone()),t.camera.position.addVectors(m.clone(),v.clone()),t.update(),t.camera.updateMatrixWorld(),this.showAxes()}}),this.addEventListener("touchstart",function(e){var i=e.domEvent;switch(i.touches.length){case 1:y=b.ROTATE,a.set(i.touches[0].pageX-window.scrollX,i.touches[0].pageY-window.scrollY);break;case 2:y=b.NONE,u=new o.Vector3(0,0,1);var s=(new o.Matrix4).extractRotation(this.camera.matrix);u.applyMatrix4(s),p=t.center.clone(),m=t.camera.position.clone(),f=w(e.mouseRay,p,u),v[0]=new o.Vector2(i.touches[0].pageX,i.touches[0].pageY),v[1]=new o.Vector2(i.touches[1].pageX,i.touches[1].pageY),g[0]=new o.Vector2(0,0),g[1]=new o.Vector2(0,0)}this.showAxes(),i.preventDefault()}),this.addEventListener("touchmove",function(e){var i=e.domEvent;if(y===b.ROTATE)n.set(i.touches[0].pageX-window.scrollX,i.touches[0].pageY-window.scrollY),c.subVectors(n,a),t.rotateLeft(2*Math.PI*c.x/s*t.userRotateSpeed),t.rotateUp(2*Math.PI*c.y/s*t.userRotateSpeed),a.copy(n),this.showAxes();else{if(g[0].set(v[0].x-i.touches[0].pageX,v[0].y-i.touches[0].pageY),g[1].set(v[1].x-i.touches[1].pageX,v[1].y-i.touches[1].pageY),g[0].lengthSq()>r&&g[1].lengthSq()>r&&(v[0].set(i.touches[0].pageX,i.touches[0].pageY),v[1].set(i.touches[1].pageX,i.touches[1].pageY),g[0].dot(g[1])>0&&y!==b.ZOOM?y=b.MOVE:g[0].dot(g[1])<0&&y!==b.MOVE&&(y=b.ZOOM),y===b.ZOOM)){var h=new o.Vector2;h.subVectors(v[0],v[1]),g[0].dot(h)<0&&g[1].dot(h)>0?t.zoomOut():g[0].dot(h)>0&&g[1].dot(h)<0&&t.zoomIn()}if(y===b.MOVE){var l=w(e.mouseRay,t.center,u);if(!l)return;var d=(new o.Vector3).subVectors(f.clone(),l.clone());t.center.addVectors(p.clone(),d.clone()),t.camera.position.addVectors(m.clone(),d.clone()),t.update(),t.camera.updateMatrixWorld()}this.showAxes(),i.preventDefault()}}),this.addEventListener("touchend",function(e){var t=e.domEvent;1===t.touches.length&&y!==b.ROTATE?(y=b.ROTATE,a.set(t.touches[0].pageX-window.scrollX,t.touches[0].pageY-window.scrollY)):y=b.NONE}),this.addEventListener("mousewheel",x),this.addEventListener("DOMMouseScroll",x)}showAxes(){var e=this;this.axes.traverse(function(e){e.visible=!0}),this.hideTimeout&&clearTimeout(this.hideTimeout),this.hideTimeout=setTimeout(function(){e.axes.traverse(function(e){e.visible=!1}),e.hideTimeout=!1},1e3)}rotateLeft(e){void 0===e&&(e=2*Math.PI/60/60*this.autoRotateSpeed),this.thetaDelta-=e}rotateRight(e){void 0===e&&(e=2*Math.PI/60/60*this.autoRotateSpeed),this.thetaDelta+=e}rotateUp(e){void 0===e&&(e=2*Math.PI/60/60*this.autoRotateSpeed),this.phiDelta-=e}rotateDown(e){void 0===e&&(e=2*Math.PI/60/60*this.autoRotateSpeed),this.phiDelta+=e}zoomIn(e){void 0===e&&(e=Math.pow(.95,this.userZoomSpeed)),this.scale/=e}zoomOut(e){void 0===e&&(e=Math.pow(.95,this.userZoomSpeed)),this.scale*=e}update(){var e=this.camera.position,t=e.clone().sub(this.center),i=Math.atan2(t.y,t.x),s=Math.atan2(Math.sqrt(t.y*t.y+t.x*t.x),t.z);this.autoRotate&&this.rotateLeft(2*Math.PI/60/60*this.autoRotateSpeed),i+=this.thetaDelta,s+=this.phiDelta;s=Math.max(1e-6,Math.min(Math.PI-1e-6,s));var o=t.length();t.set(o*Math.sin(s)*Math.cos(i),o*Math.sin(s)*Math.sin(i),o*Math.cos(s)),t.multiplyScalar(this.scale),e.copy(this.center).add(t),this.camera.lookAt(this.center),o=t.length(),this.axes.position.copy(this.center),this.axes.scale.set(.05*o,.05*o,.05*o),this.axes.updateMatrixWorld(!0),this.thetaDelta=0,this.phiDelta=0,this.scale=1,this.lastPosition.distanceTo(this.camera.position)>0&&(this.dispatchEvent({type:"change"}),this.lastPosition.copy(this.camera.position))}}return e.MARKER_ARROW=r,e.MARKER_CUBE=a,e.MARKER_SPHERE=n,e.MARKER_CYLINDER=c,e.MARKER_LINE_STRIP=h,e.MARKER_LINE_LIST=l,e.MARKER_CUBE_LIST=d,e.MARKER_SPHERE_LIST=p,e.MARKER_POINTS=u,e.MARKER_TEXT_VIEW_FACING=m,e.MARKER_MESH_RESOURCE=f,e.MARKER_TRIANGLE_LIST=v,e.INTERACTIVE_MARKER_KEEP_ALIVE=0,e.INTERACTIVE_MARKER_POSE_UPDATE=g,e.INTERACTIVE_MARKER_MENU_SELECT=b,e.INTERACTIVE_MARKER_BUTTON_CLICK=y,e.INTERACTIVE_MARKER_MOUSE_DOWN=w,e.INTERACTIVE_MARKER_MOUSE_UP=x,e.INTERACTIVE_MARKER_NONE=T,e.INTERACTIVE_MARKER_MENU=1,e.INTERACTIVE_MARKER_BUTTON=E,e.INTERACTIVE_MARKER_MOVE_AXIS=M,e.INTERACTIVE_MARKER_MOVE_PLANE=k,e.INTERACTIVE_MARKER_ROTATE_AXIS=C,e.INTERACTIVE_MARKER_MOVE_ROTATE=6,e.INTERACTIVE_MARKER_MOVE_3D=A,e.INTERACTIVE_MARKER_ROTATE_3D=8,e.INTERACTIVE_MARKER_MOVE_ROTATE_3D=N,e.INTERACTIVE_MARKER_INHERIT=O,e.INTERACTIVE_MARKER_FIXED=_,e.INTERACTIVE_MARKER_VIEW_FACING=R,e.makeColorMaterial=D,e.intersectPlane=S,e.findClosestPoint=P,e.closestAxisPoint=j,e.DepthCloud=class extends o.Object3D{constructor(e){super(),e=e||{},this.url=e.url,this.streamType=e.streamType||"vp8",this.f=e.f||526,this.maxDepthPerTile=e.maxDepthPerTile||1,this.pointSize=e.pointSize||3,this.width=e.width||1024,this.height=e.height||1024,this.resolutionFactor=Math.max(this.width,this.height)/1024,this.whiteness=e.whiteness||0,this.varianceThreshold=e.varianceThreshold||16667e-9,this.isMjpeg="mjpeg"===this.streamType.toLowerCase(),this.video=document.createElement(this.isMjpeg?"img":"video"),this.video.addEventListener(this.isMjpeg?"load":"loadedmetadata",this.metaLoaded.bind(this),!1),this.isMjpeg||(this.video.loop=!0),this.video.src=this.url,this.video.crossOrigin="Anonymous",this.video.setAttribute("crossorigin","Anonymous"),this.vertex_shader=["uniform sampler2D map;","","uniform float width;","uniform float height;","uniform float nearClipping, farClipping;","","uniform float pointSize;","uniform float zOffset;","","uniform float focallength;","uniform float maxDepthPerTile;","uniform float resolutionFactor;","","varying vec2 vUvP;","varying vec2 colorP;","","varying float depthVariance;","varying float maskVal;","","float sampleDepth(vec2 pos)","  {","    float depth;","    ","    vec2 vUv = vec2( pos.x / (width*2.0), pos.y / (height*2.0)+0.5 );","    vec2 vUv2 = vec2( pos.x / (width*2.0)+0.5, pos.y / (height*2.0)+0.5 );","    ","    vec4 depthColor = texture2D( map, vUv );","    ","    depth = ( depthColor.r + depthColor.g + depthColor.b ) / 3.0 ;","    ","    if (depth>0.99)","    {","      vec4 depthColor2 = texture2D( map, vUv2 );","      float depth2 = ( depthColor2.r + depthColor2.g + depthColor2.b ) / 3.0 ;","      depth = 0.99+depth2;","    }","    ","    return depth;","  }","","float median(float a, float b, float c)","  {","    float r=a;","    ","    if ( (a<b) && (b<c) )","    {","      r = b;","    }","    if ( (a<c) && (c<b) )","    {","      r = c;","    }","    return r;","  }","","float variance(float d1, float d2, float d3, float d4, float d5, float d6, float d7, float d8, float d9)","  {","    float mean = (d1 + d2 + d3 + d4 + d5 + d6 + d7 + d8 + d9) / 9.0;","    float t1 = (d1-mean);","    float t2 = (d2-mean);","    float t3 = (d3-mean);","    float t4 = (d4-mean);","    float t5 = (d5-mean);","    float t6 = (d6-mean);","    float t7 = (d7-mean);","    float t8 = (d8-mean);","    float t9 = (d9-mean);","    float v = (t1*t1+t2*t2+t3*t3+t4*t4+t5*t5+t6*t6+t7*t7+t8*t8+t9*t9)/9.0;","    return v;","  }","","vec2 decodeDepth(vec2 pos)","  {","    vec2 ret;","    ","    ","    float depth1 = sampleDepth(vec2(position.x-1.0, position.y-1.0));","    float depth2 = sampleDepth(vec2(position.x, position.y-1.0));","    float depth3 = sampleDepth(vec2(position.x+1.0, position.y-1.0));","    float depth4 = sampleDepth(vec2(position.x-1.0, position.y));","    float depth5 = sampleDepth(vec2(position.x, position.y));","    float depth6 = sampleDepth(vec2(position.x+1.0, position.y));","    float depth7 = sampleDepth(vec2(position.x-1.0, position.y+1.0));","    float depth8 = sampleDepth(vec2(position.x, position.y+1.0));","    float depth9 = sampleDepth(vec2(position.x+1.0, position.y+1.0));","    ","    float median1 = median(depth1, depth2, depth3);","    float median2 = median(depth4, depth5, depth6);","    float median3 = median(depth7, depth8, depth9);","    ","    ret.x = median(median1, median2, median3);","    ret.y = variance(depth1, depth2, depth3, depth4, depth5, depth6, depth7, depth8, depth9);","    ","    return ret;","    ","  }","","","void main() {","  ","  vUvP = vec2( position.x / (width*2.0), position.y / (height*2.0)+0.5 );","  colorP = vec2( position.x / (width*2.0)+0.5 , position.y / (height*2.0)  );","  ","  vec4 pos = vec4(0.0,0.0,0.0,0.0);","  depthVariance = 0.0;","  ","  if ( (vUvP.x<0.0)|| (vUvP.x>0.5) || (vUvP.y<0.5) || (vUvP.y>0.0))","  {","    vec2 smp = decodeDepth(vec2(position.x, position.y));","    float depth = smp.x;","    depthVariance = smp.y;","    ","    float z = -depth;","    ","    pos = vec4(","      ( position.x / width - 0.5 ) * z * 0.5 * maxDepthPerTile * resolutionFactor * (1000.0/focallength) * -1.0,","      ( position.y / height - 0.5 ) * z * 0.5 * maxDepthPerTile * resolutionFactor * (1000.0/focallength),","      (- z + zOffset / 1000.0) * maxDepthPerTile,","      1.0);","    ","    vec2 maskP = vec2( position.x / (width*2.0), position.y / (height*2.0)  );","    vec4 maskColor = texture2D( map, maskP );","    maskVal = ( maskColor.r + maskColor.g + maskColor.b ) / 3.0 ;","  }","  ","  gl_PointSize = pointSize;","  gl_Position = projectionMatrix * modelViewMatrix * pos;","  ","}"].join("\n"),this.fragment_shader=["uniform sampler2D map;","uniform float varianceThreshold;","uniform float whiteness;","","varying vec2 vUvP;","varying vec2 colorP;","","varying float depthVariance;","varying float maskVal;","","","void main() {","  ","  vec4 color;","  ","  if ( (depthVariance>varianceThreshold) || (maskVal>0.5) ||(vUvP.x<0.0)|| (vUvP.x>0.5) || (vUvP.y<0.5) || (vUvP.y>1.0))","  {  ","    discard;","  }","  else ","  {","    color = texture2D( map, colorP );","    ","    float fader = whiteness /100.0;","    ","    color.r = color.r * (1.0-fader)+ fader;","    ","    color.g = color.g * (1.0-fader)+ fader;","    ","    color.b = color.b * (1.0-fader)+ fader;","    ","    color.a = 1.0;//smoothstep( 20000.0, -20000.0, gl_FragCoord.z / gl_FragCoord.w );","  }","  ","  gl_FragColor = vec4( color.r, color.g, color.b, color.a );","  ","}"].join("\n")}metaLoaded(){this.metaLoaded=!0,this.initStreamer()}initStreamer(){if(this.metaLoaded){this.texture=new o.Texture(this.video),this.geometry=new o.Geometry;for(var e=0,t=this.width*this.height;e<t;e++){var i=new o.Vector3;i.x=e%this.width,i.y=Math.floor(e/this.width),this.geometry.vertices.push(i)}this.material=new o.ShaderMaterial({uniforms:{map:{type:"t",value:this.texture},width:{type:"f",value:this.width},height:{type:"f",value:this.height},focallength:{type:"f",value:this.f},pointSize:{type:"f",value:this.pointSize},zOffset:{type:"f",value:0},whiteness:{type:"f",value:this.whiteness},varianceThreshold:{type:"f",value:this.varianceThreshold},maxDepthPerTile:{type:"f",value:this.maxDepthPerTile},resolutionFactor:{type:"f",value:this.resolutionFactor}},vertexShader:this.vertex_shader,fragmentShader:this.fragment_shader}),this.mesh=new o.ParticleSystem(this.geometry,this.material),this.mesh.position.x=0,this.mesh.position.y=0,this.add(this.mesh);var s=this;this.interval=setInterval(function(){(s.isMjpeg||s.video.readyState===s.video.HAVE_ENOUGH_DATA)&&(s.texture.needsUpdate=!0)},1e3/30)}}startStream(){this.isMjpeg||this.video.play()}stopStream(){this.isMjpeg||this.video.pause(),this.video.src="",clearInterval(this.interval),this.remove(this.mesh),this.texture&&this.texture.dispose(),this.geometry&&this.geometry.dispose(),this.material&&this.material.dispose()}},e.CloseCloud=L,e.InteractiveMarker=G,e.InteractiveMarkerClient=class{constructor(e){e=e||{},this.ros=e.ros,this.tfClient=e.tfClient,this.topicName=e.topic,this.path=e.path||"/",this.camera=e.camera,this.rootObject=e.rootObject||new o.Object3D,this.loader=e.loader,this.menuFontSize=e.menuFontSize||"0.8em",this.interactiveMarkers={},this.updateTopic=null,this.feedbackTopic=null,this.topicName&&this.subscribe(this.topicName)}subscribe(e){this.unsubscribe(),this.updateTopic=new i.Topic({ros:this.ros,name:e+"/tunneled/update",messageType:"visualization_msgs/InteractiveMarkerUpdate",compression:"png"}),this.updateTopic.subscribe(this.processUpdate.bind(this)),this.feedbackTopic=new i.Topic({ros:this.ros,name:e+"/feedback",messageType:"visualization_msgs/InteractiveMarkerFeedback",compression:"png"}),this.feedbackTopic.advertise(),this.initService=new i.Service({ros:this.ros,name:e+"/tunneled/get_init",serviceType:"demo_interactive_markers/GetInit"});var t=new i.ServiceRequest({});this.initService.callService(t,this.processInit.bind(this))}unsubscribe(){for(var e in this.updateTopic&&this.updateTopic.unsubscribe(),this.feedbackTopic&&this.feedbackTopic.unadvertise(),this.interactiveMarkers)this.eraseIntMarker(e);this.interactiveMarkers={}}processInit(e){var t=e.msg;for(var i in t.erases=[],this.interactiveMarkers)t.erases.push(i);t.poses=[],this.processUpdate(t)}processUpdate(e){var t=this;e.erases.forEach(function(e){t.eraseIntMarker(e)}),e.poses.forEach(function(e){var i=t.interactiveMarkers[e.name];i&&i.setPoseFromServer(e.pose)}),e.markers.forEach(function(e){var i=t.interactiveMarkers[e.name];i&&t.eraseIntMarker(i.name);var s=new q({message:e,feedbackTopic:t.feedbackTopic,tfClient:t.tfClient,menuFontSize:t.menuFontSize});t.interactiveMarkers[e.name]=s;var o=new G({handle:s,camera:t.camera,path:t.path,loader:t.loader});o.name=e.name,t.rootObject.add(o),s.on("pose",function(e){o.onServerSetPose({pose:e})}),o.addEventListener("user-pose-change",s.setPoseFromClientBound),o.addEventListener("user-mousedown",s.onMouseDownBound),o.addEventListener("user-mouseup",s.onMouseUpBound),o.addEventListener("user-button-click",s.onButtonClickBound),o.addEventListener("menu-select",s.onMenuSelectBound),s.subscribeTf()})}eraseIntMarker(e){if(this.interactiveMarkers[e]){var t=this.rootObject.getObjectByName(e);this.rootObject.remove(t);var i=this.interactiveMarkers[e];i.unsubscribeTf(),t.removeEventListener("user-pose-change",i.setPoseFromClientBound),t.removeEventListener("user-mousedown",i.onMouseDownBound),t.removeEventListener("user-mouseup",i.onMouseUpBound),t.removeEventListener("user-button-click",i.onButtonClickBound),t.removeEventListener("menu-select",i.onMenuSelectBound),delete this.interactiveMarkers[e],t.dispose()}}},e.InteractiveMarkerControl=U,e.InteractiveMarkerHandle=q,e.InteractiveMarkerMenu=B,e.Marker=F,e.MarkerArrayClient=class extends s{constructor(e){super(),e=e||{},this.ros=e.ros,this.topicName=e.topic,this.tfClient=e.tfClient,this.rootObject=e.rootObject||new o.Object3D,this.path=e.path||"/",this.markers={},this.rosTopic=void 0,this.subscribe()}subscribe(){this.unsubscribe(),this.rosTopic=new i.Topic({ros:this.ros,name:this.topicName,messageType:"visualization_msgs/MarkerArray",compression:"png"}),this.rosTopic.subscribe(this.processMessage.bind(this))}processMessage(e){e.markers.forEach(function(e){if(0===e.action){var t=!1;if(e.ns+e.id in this.markers&&((t=this.markers[e.ns+e.id].children[0].update(e))||(this.markers[e.ns+e.id].unsubscribeTf(),this.markers[e.ns+e.id].children[0].dispose(),this.rootObject.remove(this.markers[e.ns+e.id]))),!t){var i=new F({message:e,path:this.path});this.markers[e.ns+e.id]=new H({frameID:e.header.frame_id.replace(/^\//,""),tfClient:this.tfClient,object:i}),this.rootObject.add(this.markers[e.ns+e.id])}}else if(1===e.action)console.warn('Received marker message with deprecated action identifier "1"');else if(2===e.action)e.ns+e.id in this.markers&&(this.markers[e.ns+e.id].unsubscribeTf(),this.markers[e.ns+e.id].children[0].dispose(),this.rootObject.remove(this.markers[e.ns+e.id]),delete this.markers[e.ns+e.id]);else if(3===e.action){for(var s in this.markers)this.markers[s].unsubscribeTf(),this.markers[s].children[0].dispose(),this.rootObject.remove(this.markers[s]);this.markers={}}else console.warn('Received marker message with unknown action identifier "'+e.action+'"')}.bind(this)),this.emit("change")}unsubscribe(){this.rosTopic&&this.rosTopic.unsubscribe()}removeArray(){for(var e in this.rosTopic.unsubscribe(),this.markers)this.markers.hasOwnProperty(e)&&(this.markers[e].unsubscribeTf(),this.markers[e].children[0].dispose(),this.rootObject.remove(this.markers[e]));this.markers={}}},e.MarkerClient=class extends s{constructor(e){super(),e=e||{},this.ros=e.ros,this.topicName=e.topic,this.tfClient=e.tfClient,this.rootObject=e.rootObject||new o.Object3D,this.path=e.path||"/",this.lifetime=e.lifetime||0,this.markers={},this.rosTopic=void 0,this.updatedTime={},this.subscribe()}unsubscribe(){this.rosTopic&&this.rosTopic.unsubscribe()}checkTime(e){if((new Date).getTime()-this.updatedTime[e]>this.lifetime){var t=this.markers[e];t.unsubscribeTf(),this.rootObject.remove(t),this.emit("change")}else{var i=this;setTimeout(function(){i.checkTime(e)},100)}}subscribe(){this.unsubscribe(),this.rosTopic=new i.Topic({ros:this.ros,name:this.topicName,messageType:"visualization_msgs/Marker",compression:"png"}),this.rosTopic.subscribe(this.processMessage.bind(this))}processMessage(e){var t=new F({message:e,path:this.path}),i=this.markers[e.ns+e.id];this.updatedTime[e.ns+e.id]=(new Date).getTime(),i?(i.unsubscribeTf(),this.rootObject.remove(i)):this.lifetime&&this.checkTime(e.ns+e.id),this.markers[e.ns+e.id]=new H({frameID:e.header.frame_id,tfClient:this.tfClient,object:t}),this.rootObject.add(this.markers[e.ns+e.id]),this.emit("change")}},e.Arrow=V,e.Arrow2=class extends o.ArrowHelper{constructor(e){var t=(e=e||{}).origin||new o.Vector3(0,0,0),i=e.direction||new o.Vector3(1,0,0),s=e.length||1;e.headLength,e.shaftDiameter,e.headDiameter,e.material||new o.MeshBasicMaterial,super(i,t,s,16711680)}dispose(){void 0!==this.line&&(this.line.material.dispose(),this.line.geometry.dispose()),void 0!==this.cone&&(this.cone.material.dispose(),this.cone.geometry.dispose())}},e.Axes=W,e.Grid=class extends o.Object3D{constructor(e){var t=(e=e||{}).num_cells||10,i=e.color||"#cccccc",s=e.lineWidth||1,r=e.cellSize||1;super();for(var a=new o.LineBasicMaterial({color:i,linewidth:s}),n=0;n<=t;++n){var c=r*t/2,h=c-n*r,l=new o.Geometry;l.vertices.push(new o.Vector3(-c,h,0),new o.Vector3(c,h,0));var d=new o.Geometry;d.vertices.push(new o.Vector3(h,-c,0),new o.Vector3(h,c,0)),this.add(new o.Line(l,a)),this.add(new o.Line(d,a))}}},e.MeshResource=I,e.TriangleList=z,e.OccupancyGrid=K,e.OccupancyGridClient=class extends s{constructor(e){super(),e=e||{},this.ros=e.ros,this.topicName=e.topic||"/map",this.compression=e.compression||"cbor",this.continuous=e.continuous,this.tfClient=e.tfClient,this.rootObject=e.rootObject||new o.Object3D,this.offsetPose=e.offsetPose||new i.Pose,this.color=e.color||{r:255,g:255,b:255},this.opacity=e.opacity||1,this.currentGrid=null,this.rosTopic=void 0,this.subscribe()}unsubscribe(){this.rosTopic&&this.rosTopic.unsubscribe()}subscribe(){this.unsubscribe(),this.rosTopic=new i.Topic({ros:this.ros,name:this.topicName,messageType:"nav_msgs/OccupancyGrid",queue_length:1,compression:this.compression}),this.rosTopic.subscribe(this.processMessage.bind(this))}processMessage(e){this.currentGrid&&(this.currentGrid.tfClient&&this.currentGrid.unsubscribeTf(),this.rootObject.remove(this.currentGrid));var t=new K({message:e,color:this.color,opacity:this.opacity});this.tfClient?(this.currentGrid=t,this.sceneNode=new H({frameID:e.header.frame_id,tfClient:this.tfClient,object:t,pose:this.offsetPose})):this.sceneNode=this.currentGrid=t,this.rootObject.add(this.sceneNode),this.emit("change"),this.continuous||this.rosTopic.unsubscribe()}},e.Odometry=class extends o.Object3D{constructor(e){super(),this.options=e||{},this.ros=e.ros,this.topicName=e.topic||"/particlecloud",this.tfClient=e.tfClient,this.color=e.color||13369599,this.length=e.length||1,this.rootObject=e.rootObject||new o.Object3D,this.keep=e.keep||1,this.sns=[],this.rosTopic=void 0,this.subscribe()}unsubscribe(){this.rosTopic&&this.rosTopic.unsubscribe()}subscribe(){this.unsubscribe(),this.rosTopic=new i.Topic({ros:this.ros,name:this.topicName,queue_length:1,messageType:"nav_msgs/Odometry"}),this.rosTopic.subscribe(this.processMessage.bind(this))}processMessage(e){this.sns.length>=this.keep&&(this.sns[0].unsubscribeTf(),this.rootObject.remove(this.sns[0]),this.sns.shift()),this.options.origin=new o.Vector3(e.pose.pose.position.x,e.pose.pose.position.y,e.pose.pose.position.z);var t=new o.Quaternion(e.pose.pose.orientation.x,e.pose.pose.orientation.y,e.pose.pose.orientation.z,e.pose.pose.orientation.w);this.options.direction=new o.Vector3(1,0,0),this.options.direction.applyQuaternion(t),this.options.material=new o.MeshBasicMaterial({color:this.color});var i=new V(this.options);this.sns.push(new H({frameID:e.header.frame_id,tfClient:this.tfClient,object:i})),this.rootObject.add(this.sns[this.sns.length-1])}},e.Path=class extends o.Object3D{constructor(e){super(),e=e||{},this.ros=e.ros,this.topicName=e.topic||"/path",this.tfClient=e.tfClient,this.color=e.color||13369599,this.rootObject=e.rootObject||new o.Object3D,this.sn=null,this.line=null,this.rosTopic=void 0,this.subscribe()}unsubscribe(){this.rosTopic&&this.rosTopic.unsubscribe()}subscribe(){this.unsubscribe(),this.rosTopic=new i.Topic({ros:this.ros,name:this.topicName,queue_length:1,messageType:"nav_msgs/Path"}),this.rosTopic.subscribe(this.processMessage.bind(this))}processMessage(e){null!==this.sn&&(this.sn.unsubscribeTf(),this.rootObject.remove(this.sn));for(var t=new o.Geometry,i=0;i<e.poses.length;i++){var s=new o.Vector3(e.poses[i].pose.position.x,e.poses[i].pose.position.y,e.poses[i].pose.position.z);t.vertices.push(s)}t.computeLineDistances();var r=new o.LineBasicMaterial({color:this.color}),a=new o.Line(t,r);this.sn=new H({frameID:e.header.frame_id,tfClient:this.tfClient,object:a}),this.rootObject.add(this.sn)}},e.Point=class extends o.Object3D{constructor(e){super(),this.options=e||{},this.ros=e.ros,this.topicName=e.topic||"/point",this.tfClient=e.tfClient,this.color=e.color||13369599,this.rootObject=e.rootObject||new o.Object3D,this.radius=e.radius||.2,this.sn=null,this.rosTopic=void 0,this.subscribe()}unsubscribe(){this.rosTopic&&this.rosTopic.unsubscribe()}subscribe(){this.unsubscribe(),this.rosTopic=new i.Topic({ros:this.ros,name:this.topicName,queue_length:1,messageType:"geometry_msgs/PointStamped"}),this.rosTopic.subscribe(this.processMessage.bind(this))}processMessage(e){null!==this.sn&&(this.sn.unsubscribeTf(),this.rootObject.remove(this.sn));var t=new o.SphereGeometry(this.radius),i=new o.MeshBasicMaterial({color:this.color}),s=new o.Mesh(t,i);s.position.set(e.point.x,e.point.y,e.point.z),this.sn=new H({frameID:e.header.frame_id,tfClient:this.tfClient,object:s}),this.rootObject.add(this.sn)}},e.Polygon=class extends o.Object3D{constructor(e){super(),e=e||{},this.ros=e.ros,this.topicName=e.topic||"/path",this.tfClient=e.tfClient,this.color=e.color||13369599,this.rootObject=e.rootObject||new o.Object3D,this.sn=null,this.line=null,this.rosTopic=void 0,this.subscribe()}unsubscribe(){this.rosTopic&&this.rosTopic.unsubscribe()}subscribe(){this.unsubscribe(),this.rosTopic=new i.Topic({ros:this.ros,name:this.topicName,queue_length:1,messageType:"geometry_msgs/PolygonStamped"}),this.rosTopic.subscribe(this.processMessage.bind(this))}processMessage(e){null!==this.sn&&(this.sn.unsubscribeTf(),this.rootObject.remove(this.sn));for(var t,i=new o.Geometry,s=0;s<e.polygon.points.length;s++)t=new o.Vector3(e.polygon.points[s].x,e.polygon.points[s].y,e.polygon.points[s].z),i.vertices.push(t);t=new o.Vector3(e.polygon.points[0].x,e.polygon.points[0].y,e.polygon.points[0].z),i.vertices.push(t),i.computeLineDistances();var r=new o.LineBasicMaterial({color:this.color}),a=new o.Line(i,r);this.sn=new H({frameID:e.header.frame_id,tfClient:this.tfClient,object:a}),this.rootObject.add(this.sn)}},e.Pose=class extends o.Object3D{constructor(e){super(),this.options=e||{},this.ros=e.ros,this.topicName=e.topic||"/pose",this.tfClient=e.tfClient,this.color=e.color||13369599,this.rootObject=e.rootObject||new o.Object3D,this.sn=null,this.rosTopic=void 0,this.subscribe()}unsubscribe(){this.rosTopic&&this.rosTopic.unsubscribe()}subscribe(){this.unsubscribe(),this.rosTopic=new i.Topic({ros:this.ros,name:this.topicName,queue_length:1,messageType:"geometry_msgs/PoseStamped"}),this.rosTopic.subscribe(this.processMessage.bind(this))}processMessage(e){null!==this.sn&&(this.sn.unsubscribeTf(),this.rootObject.remove(this.sn)),this.options.origin=new o.Vector3(e.pose.position.x,e.pose.position.y,e.pose.position.z);var t=new o.Quaternion(e.pose.orientation.x,e.pose.orientation.y,e.pose.orientation.z,e.pose.orientation.w);this.options.direction=new o.Vector3(1,0,0),this.options.direction.applyQuaternion(t),this.options.material=new o.MeshBasicMaterial({color:this.color});var i=new V(this.options);this.sn=new H({frameID:e.header.frame_id,tfClient:this.tfClient,object:i}),this.rootObject.add(this.sn)}},e.PoseArray=class extends o.Object3D{constructor(e){super(),this.options=e||{},this.ros=e.ros,this.topicName=e.topic||"/particlecloud",this.tfClient=e.tfClient,this.color=e.color||13369599,this.length=e.length||1,this.rootObject=e.rootObject||new o.Object3D,this.sn=null,this.rosTopic=void 0,this.subscribe()}unsubscribe(){this.rosTopic&&this.rosTopic.unsubscribe()}subscribe(){this.unsubscribe(),this.rosTopic=new i.Topic({ros:this.ros,name:this.topicName,queue_length:1,messageType:"geometry_msgs/PoseArray"}),this.rosTopic.subscribe(this.processMessage.bind(this))}processMessage(e){null!==this.sn&&(this.sn.unsubscribeTf(),this.rootObject.remove(this.sn));for(var t,i=new o.Object3D,s=0;s<e.poses.length;s++){var r=new o.Geometry,a=new o.Vector3(e.poses[s].position.x,e.poses[s].position.y,e.poses[s].position.z);r.vertices.push(a);var n=new o.Quaternion(e.poses[s].orientation.x,e.poses[s].orientation.y,e.poses[s].orientation.z,e.poses[s].orientation.w),c=new o.Vector3(this.length,0,0),h=new o.Vector3(.8*this.length,.2*this.length,0),l=new o.Vector3(.8*this.length,.2*-this.length,0);c.applyQuaternion(n),h.applyQuaternion(n),l.applyQuaternion(n),r.vertices.push(c.add(a)),r.vertices.push(h.add(a)),r.vertices.push(l.add(a)),r.vertices.push(c),r.computeLineDistances();var d=new o.LineBasicMaterial({color:this.color});t=new o.Line(r,d),i.add(t)}this.sn=new H({frameID:e.header.frame_id,tfClient:this.tfClient,object:i}),this.rootObject.add(this.sn)}},e.PoseWithCovariance=class extends o.Object3D{constructor(e){super(),this.options=e||{},this.ros=e.ros,this.topicName=e.topic||"/PoseWithCovariance",this.tfClient=e.tfClient,this.color=e.color||13369599,this.rootObject=e.rootObject||new o.Object3D,this.sn=null,this.rosTopic=void 0,this.subscribe()}unsubscribe(){this.rosTopic&&this.rosTopic.unsubscribe()}subscribe(){this.unsubscribe(),this.rosTopic=new i.Topic({ros:this.ros,name:this.topicName,queue_length:1,messageType:"geometry_msgs/PoseWithCovarianceStamped"}),this.rosTopic.subscribe(this.processMessage.bind(this))}processMessage(e){null!==this.sn&&(this.sn.unsubscribeTf(),this.rootObject.remove(this.sn)),this.options.origin=new o.Vector3(e.pose.pose.position.x,e.pose.pose.position.y,e.pose.pose.position.z);var t=new o.Quaternion(e.pose.pose.orientation.x,e.pose.pose.orientation.y,e.pose.pose.orientation.z,e.pose.pose.orientation.w);this.options.direction=new o.Vector3(1,0,0),this.options.direction.applyQuaternion(t),this.options.material=new o.MeshBasicMaterial({color:this.color});var i=new V(this.options);this.sn=new H({frameID:e.header.frame_id,tfClient:this.tfClient,object:i}),this.rootObject.add(this.sn)}},e.LaserScan=class extends o.Object3D{constructor(e){super(),e=e||{},this.ros=e.ros,this.topicName=e.topic||"/scan",this.compression=e.compression||"cbor",this.points=new Q(e),this.rosTopic=void 0,this.subscribe()}unsubscribe(){this.rosTopic&&this.rosTopic.unsubscribe()}subscribe(){this.unsubscribe(),this.rosTopic=new i.Topic({ros:this.ros,name:this.topicName,compression:this.compression,queue_length:1,messageType:"sensor_msgs/LaserScan"}),this.rosTopic.subscribe(this.processMessage.bind(this))}processMessage(e){if(this.points.setup(e.header.frame_id)){for(var t=e.ranges.length,i=0,s=0;s<t;s+=this.points.pointRatio){var o=e.ranges[s];if(o>=e.range_min&&o<=e.range_max){var r=e.angle_min+s*e.angle_increment;this.points.positions.array[i++]=o*Math.cos(r),this.points.positions.array[i++]=o*Math.sin(r),this.points.positions.array[i++]=0}}this.points.update(i/3)}}},e.Points=Q,e.PointCloud2=class extends o.Object3D{constructor(e){super(),e=e||{},this.ros=e.ros,this.topicName=e.topic||"/points",this.compression=e.compression||"cbor",this.max_pts=e.max_pts||1e4,this.points=new Q(e),this.rosTopic=void 0,this.buffer=null,this.subscribe()}unsubscribe(){this.rosTopic&&this.rosTopic.unsubscribe()}subscribe(){this.unsubscribe(),this.rosTopic=new i.Topic({ros:this.ros,name:this.topicName,messageType:"sensor_msgs/PointCloud2",queue_length:1,compression:this.compression}),this.rosTopic.subscribe(this.processMessage.bind(this))}processMessage(e){if(this.points.setup(e.header.frame_id,e.point_step,e.fields)){var t,i=this.points.pointRatio,s=this.max_pts*e.point_step;e.data.buffer?(this.buffer=e.data.slice(0,Math.min(e.data.byteLength,s)),t=Math.min(e.height*e.width/i,this.points.positions.array.length/3)):((!this.buffer||this.buffer.byteLength<s)&&(this.buffer=new Uint8Array(s)),t=X(e.data,this.buffer,e.point_step,i),i=1);for(var o,r,a=new DataView(this.buffer.buffer),n=!e.is_bigendian,c=this.points.fields.x.offset,h=this.points.fields.y.offset,l=this.points.fields.z.offset,d=0;d<t;d++)o=d*i*e.point_step,this.points.positions.array[3*d]=a.getFloat32(o+c,n),this.points.positions.array[3*d+1]=a.getFloat32(o+h,n),this.points.positions.array[3*d+2]=a.getFloat32(o+l,n),this.points.colors&&(r=this.points.colormap(this.points.getColor(a,o,n)),this.points.colors.array[3*d]=r.r,this.points.colors.array[3*d+1]=r.g,this.points.colors.array[3*d+2]=r.b);this.points.update(t)}}},e.TFAxes=class extends o.Object3D{constructor(e){super(),e=e||{},this.frame_id=e.frame_id,this.tfClient=e.tfClient,this.rootObject=e.rootObject||new o.Object3D,this.axes=new W({shaftRadius:e.shaftRadius||.025,headRadius:e.headRaidus||.07,headLength:e.headLength||.2,scale:e.scale||1,lineType:e.lineType||"full",lineDashLength:e.lineDashLength||.1}),this.sn=new H({frameID:this.frame_id,tfClient:this.tfClient,object:this.axes}),this.rootObject.add(this.sn)}},e.Urdf=Y,e.UrdfClient=class{constructor(e){var t=this,s=(e=e||{}).ros;this.param=e.param||"robot_description",this.path=e.path||"/",this.tfClient=e.tfClient,this.rootObject=e.rootObject||new o.Object3D,this.tfPrefix=e.tfPrefix||"",this.loader=e.loader,new i.Param({ros:s,name:this.param}).get(function(e){var s=new i.UrdfModel({string:e});t.urdf=new Y({urdfModel:s,path:t.path,tfClient:t.tfClient,tfPrefix:t.tfPrefix,loader:t.loader}),t.rootObject.add(t.urdf)})}},e.Highlighter=J,e.MouseHandler=$,e.OrbitControls=ee,e.SceneNode=H,e.Viewer=class{constructor(e){var t=(e=e||{}).divID,i=e.canvas&&"canvas"===e.canvas.nodeName.toLowerCase()?e.canvas:void 0,s=e.width,r=e.height,a=e.background||"#111111",n=e.antialias,c=e.intensity||.66,h=e.near||.01,l=e.far||1e3,d=e.alpha||1,p=e.cameraPose||{x:3,y:3,z:3},u=e.cameraZoomSpeed||.5,m=void 0===e.displayPanAndZoomFrame||!!e.displayPanAndZoomFrame,f=e.lineTypePanAndZoomFrame||"full";this.renderer=new o.WebGLRenderer({canvas:i,antialias:n,alpha:!0}),this.renderer.setClearColor(parseInt(a.replace("#","0x"),16),d),this.renderer.sortObjects=!1,this.renderer.setSize(s,r),this.renderer.shadowMap.enabled=!1,this.renderer.autoClear=!1,this.scene=new o.Scene,this.camera=new o.PerspectiveCamera(40,s/r,h,l),this.camera.position.set(p.x,p.y,p.z),this.cameraControls=new ee({scene:this.scene,camera:this.camera,displayPanAndZoomFrame:m,lineTypePanAndZoomFrame:f}),this.cameraControls.userZoomSpeed=u,this.scene.add(new o.AmbientLight(5592405)),this.directionalLight=new o.DirectionalLight(16777215,c),this.scene.add(this.directionalLight),this.selectableObjects=new o.Object3D,this.scene.add(this.selectableObjects);var v=new $({renderer:this.renderer,camera:this.camera,rootObject:this.selectableObjects,fallbackTarget:this.cameraControls});if(this.highlighter=new J({mouseHandler:v}),this.stopped=!0,this.animationRequestId=void 0,t&&!i)document.getElementById(t).appendChild(this.renderer.domElement);else if(!i)throw new Error("No canvas nor HTML container provided for rendering.");this.start()}start(){this.stopped=!1,this.draw()}draw(){this.stopped||(this.cameraControls.update(),this.directionalLight.position.normalize(),this.renderer.clear(!0,!0,!0),this.renderer.render(this.scene,this.camera),this.highlighter.renderHighlights(this.scene,this.renderer,this.camera),this.animationRequestId=requestAnimationFrame(this.draw.bind(this)))}stop(){this.stopped||cancelAnimationFrame(this.animationRequestId),this.stopped=!0}addObject(e,t){t?this.selectableObjects.add(e):this.scene.add(e)}resize(e,t){this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t)}},e}({},THREE,ROSLIB,EventEmitter2);
